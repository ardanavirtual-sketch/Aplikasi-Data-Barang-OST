<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Inventori Multi-Gudang</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --gray: #95a5a6;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Segoe UI', sans-serif; }
        body { background-color: #f0f2f5; display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--dark); color: white; padding: 20px 0; position: fixed; height: 100%; z-index: 100; }
        .sidebar-brand { padding: 0 20px 30px; font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .nav-menu { list-style: none; }
        .nav-item { padding: 12px 25px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 15px; color: #bdc3c7; }
        .nav-item:hover, .nav-item.active { background: var(--primary); color: white; }
        .nav-item i { width: 20px; text-align: center; }

        /* Main Content */
        .main-content { margin-left: 260px; flex: 1; padding: 30px; width: calc(100% - 260px); }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 20px; border-radius: 12px; box-shadow: var(--shadow); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--shadow); border-left: 5px solid var(--primary); }
        .stat-card h3 { font-size: 0.8rem; color: var(--gray); text-transform: uppercase; margin-bottom: 5px; }
        .stat-card p { font-size: 1.5rem; font-weight: bold; color: var(--dark); }

        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; min-width: 600px; }
        th { text-align: left; padding: 15px; background: #f8f9fa; border-bottom: 2px solid #edf2f7; font-size: 0.85rem; color: var(--gray); text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 15px; border-bottom: 1px solid #edf2f7; vertical-align: middle; font-size: 0.95rem; }

        .badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-dark { background: #e2e8f0; color: #475569; border: 1px solid #cbd5e1; }

        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

        .stock-main { font-weight: bold; font-size: 1.1rem; color: var(--dark); }

        /* Modal */
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }

        #toast { position: fixed; bottom: 30px; right: 30px; padding: 15px 30px; border-radius: 10px; color: white; display: none; z-index: 2000; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-brand"><i class="fas fa-boxes-stacked"></i> INV-GUDANG</div>
        <ul class="nav-menu">
            <li class="nav-item active" id="nav-dashboard" onclick="switchSection('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</li>
            <li class="nav-item" id="nav-gudang" onclick="switchSection('gudang')"><i class="fas fa-warehouse"></i> Daftar Gudang</li>
            <li class="nav-item" id="nav-barang" onclick="switchSection('barang')"><i class="fas fa-box"></i> Master Barang</li>
            <li class="nav-item" id="nav-stok" onclick="switchSection('stok')"><i class="fas fa-list-check"></i> Stok per Gudang</li>
            <li class="nav-item" id="nav-masuk" onclick="switchSection('masuk')"><i class="fas fa-arrow-down" style="color: var(--success)"></i> Barang Masuk</li>
            <li class="nav-item" id="nav-keluar" onclick="switchSection('keluar')"><i class="fas fa-arrow-up" style="color: var(--danger)"></i> Barang Keluar</li>
            <li class="nav-item" id="nav-settings" onclick="switchSection('settings')"><i class="fas fa-cog"></i> Pengaturan API</li>
        </ul>
    </div>

    <div class="main-content">
        <!-- Dashboard -->
        <div id="section-dashboard" class="app-section">
            <header>
                <h2>Ringkasan Multi-Gudang</h2>
                <div id="db-status"><span class="badge badge-danger">Offline</span></div>
            </header>
            <div class="stats-grid">
                <div class="stat-card"><h3>Gudang Aktif</h3><p id="stat-warehouses">0</p></div>
                <div class="stat-card"><h3>Total Jenis Barang</h3><p id="stat-items">0</p></div>
                <div class="stat-card"><h3>Masuk (Bulan Ini)</h3><p id="stat-in-month">0</p></div>
                <div class="stat-card"><h3>Keluar (Bulan Ini)</h3><p id="stat-out-month">0</p></div>
            </div>
            <div class="card">
                <h3>Log Aktivitas Terkini</h3>
                <table id="table-recent">
                    <thead><tr><th>Waktu</th><th>Barang</th><th>Tipe</th><th>Lokasi Gudang</th><th>Jumlah</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Master Gudang -->
        <div id="section-gudang" class="app-section" style="display:none;">
            <header>
                <h2>Manajemen Gudang</h2>
                <button class="btn btn-primary" onclick="openModal('gudang')"><i class="fas fa-plus"></i> Gudang Baru</button>
            </header>
            <div class="card">
                <table>
                    <thead><tr><th>Nama Gudang</th><th>Lokasi/Keterangan</th><th>Aksi</th></tr></thead>
                    <tbody id="body-gudang"></tbody>
                </table>
            </div>
        </div>

        <!-- Master Barang -->
        <div id="section-barang" class="app-section" style="display:none;">
            <header>
                <h2>Daftar Produk</h2>
                <button class="btn btn-primary" onclick="openModal('barang')"><i class="fas fa-plus"></i> Tambah Produk</button>
            </header>
            <div class="card">
                <table>
                    <thead><tr><th>Nama Barang</th><th>Konversi</th><th>Total Stok Global</th><th>Aksi</th></tr></thead>
                    <tbody id="body-barang"></tbody>
                </table>
            </div>
        </div>

        <!-- Stok per Gudang -->
        <div id="section-stok" class="app-section" style="display:none;">
            <header>
                <h2>Detail Stok per Lokasi</h2>
                <div style="display:flex; gap:10px;">
                    <select id="filter-stok-gudang" onchange="fetchStokPerGudang()" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; min-width: 200px;">
                        <option value="all">Semua Gudang</option>
                    </select>
                </div>
            </header>
            <div class="card">
                <table>
                    <thead><tr><th>Gudang</th><th>Nama Produk</th><th>Jumlah Stok (Eceran)</th><th>Status</th></tr></thead>
                    <tbody id="body-stok-gudang"></tbody>
                </table>
            </div>
        </div>

        <!-- Barang Masuk/Keluar -->
        <div id="section-masuk" class="app-section" style="display:none;">
            <header><h2>Riwayat Barang Masuk</h2><button class="btn btn-success" onclick="openModal('transaksi', {type:'IN'})">Input Masuk</button></header>
            <div class="card"><table id="table-in"><thead><tr><th>Tanggal</th><th>Barang</th><th>Tujuan Gudang</th><th>Jumlah</th><th>Aksi</th></tr></thead><tbody id="body-masuk"></tbody></table></div>
        </div>

        <div id="section-keluar" class="app-section" style="display:none;">
            <header><h2>Riwayat Barang Keluar</h2><button class="btn btn-danger" onclick="openModal('transaksi', {type:'OUT'})">Input Keluar</button></header>
            <div class="card"><table id="table-out"><thead><tr><th>Tanggal</th><th>Barang</th><th>Asal Gudang</th><th>Jumlah</th><th>Aksi</th></tr></thead><tbody id="body-keluar"></tbody></table></div>
        </div>

        <!-- Settings -->
        <div id="section-settings" class="app-section" style="display:none;">
            <header><h2>Pengaturan Database</h2></header>
            <div class="card">
                <div class="form-group"><label>URL Supabase</label><input type="text" id="cfg-url"></div>
                <div class="form-group"><label>Anon Key</label><input type="password" id="cfg-key"></div>
                <button class="btn btn-primary" onclick="saveConfig()">Simpan Konfigurasi</button>
            </div>
        </div>
    </div>

    <div id="modal-overlay"><div class="modal-content" id="modal-content"></div></div>
    <div id="toast"></div>

    <script>
        let sb = null;
        let appId = typeof __app_id !== 'undefined' ? __app_id : 'inv-multi-gudang';

        function toast(m, t='success') {
            const el = document.getElementById('toast');
            el.innerText = m; el.style.background = t==='success'?'#2ecc71':'#e74c3c';
            el.style.display='block'; setTimeout(()=>el.style.display='none', 3000);
        }

        function switchSection(id) {
            document.querySelectorAll('.app-section').forEach(s => s.style.display = 'none');
            document.getElementById('section-'+id).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('nav-'+id).classList.add('active');
            if(sb) loadDataForSection(id);
        }

        async function loadDataForSection(id) {
            if(id === 'dashboard') loadDashboard();
            if(id === 'gudang') fetchGudang();
            if(id === 'barang') fetchBarang();
            if(id === 'stok') { await syncFilterGudang(); fetchStokPerGudang(); }
            if(id === 'masuk') fetchHistory('IN');
            if(id === 'keluar') fetchHistory('OUT');
        }

        // DATABASE OPERATIONS
        async function fetchGudang() {
            const { data } = await sb.from('warehouses').select('*').order('name');
            document.getElementById('body-gudang').innerHTML = data?.map(g => `
                <tr><td><strong>${g.name}</strong></td><td>${g.location || '-'}</td>
                <td><button class="btn btn-sm btn-danger" onclick="deleteData('warehouses','${g.id}',fetchGudang)"><i class="fas fa-trash"></i></button></td></tr>
            `).join('') || '<tr><td colspan="3">Belum ada gudang</td></tr>';
        }

        async function fetchBarang() {
            const { data } = await sb.from('master_items').select('*').order('name');
            document.getElementById('body-barang').innerHTML = data?.map(b => `
                <tr>
                    <td><strong>${b.name}</strong></td>
                    <td><span class="badge badge-dark">1 ${b.unit_big} = ${b.conversion} ${b.unit_small}</span></td>
                    <td><span class="stock-main">${b.current_stock}</span> ${b.unit_small}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="deleteData('master_items','${b.id}',fetchBarang)"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('') || '';
        }

        async function fetchStokPerGudang() {
            const gudangId = document.getElementById('filter-stok-gudang').value;
            let query = sb.from('inventory_stocks').select('*, master_items(*), warehouses(*)');
            if(gudangId !== 'all') query = query.eq('warehouse_id', gudangId);
            
            const { data } = await query;
            document.getElementById('body-stok-gudang').innerHTML = data?.map(s => {
                const status = s.stock <= 0 ? 'badge-danger' : (s.stock <= 10 ? 'badge-warning' : 'badge-success');
                const statusText = s.stock <= 0 ? 'Habis' : (s.stock <= 10 ? 'Menipis' : 'Aman');
                
                return `<tr>
                    <td><span class="badge badge-dark"><i class="fas fa-warehouse"></i> ${s.warehouses.name}</span></td>
                    <td><strong>${s.master_items.name}</strong></td>
                    <td><span class="stock-main">${s.stock}</span> ${s.master_items.unit_small}</td>
                    <td><span class="badge ${status}">${statusText}</span></td>
                </tr>`;
            }).join('') || '<tr><td colspan="4">Tidak ada data stok di lokasi ini</td></tr>';
        }

        async function fetchHistory(type) {
            const { data } = await sb.from('transactions').select('*, master_items(name, unit_small), warehouses(name)').eq('type', type).order('created_at', {ascending:false});
            const tid = type==='IN'?'body-masuk':'body-keluar';
            document.getElementById(tid).innerHTML = data?.map(t => `
                <tr>
                    <td>${new Date(t.created_at).toLocaleDateString()}</td>
                    <td><strong>${t.master_items?.name}</strong></td>
                    <td><span class="badge badge-dark">${t.warehouses?.name}</span></td>
                    <td><strong>${t.total_small_unit}</strong> ${t.master_items?.unit_small}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="voidTransaction('${t.id}')">Batalkan</button></td>
                </tr>
            `).join('') || '';
        }

        // LOGIC FUNCTIONS
        async function openModal(mode, extra = null) {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            overlay.style.display = 'flex';

            if(mode === 'gudang') {
                content.innerHTML = `<h3>Tambah Gudang Baru</h3><br>
                <div class="form-group"><label>Nama Gudang</label><input id="m-g-name" placeholder="Contoh: Gudang Timur"></div>
                <div class="form-group"><label>Lokasi / Keterangan</label><textarea id="m-g-loc"></textarea></div>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn btn-primary" style="flex:1" onclick="saveGudang()">Simpan</button> 
                    <button class="btn" style="flex:1" onclick="closeModal()">Batal</button>
                </div>`;
            } else if(mode === 'barang') {
                content.innerHTML = `<h3>Tambah Produk Baru</h3><br>
                <div class="form-group"><label>Nama Barang</label><input id="m-b-name" placeholder="Contoh: Kopi Sachet"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="form-group"><label>Satuan Besar</label><input id="m-b-big" placeholder="Contoh: Dus"></div>
                    <div class="form-group"><label>Satuan Kecil (Unit Terkecil)</label><input id="m-b-small" placeholder="Contoh: Pcs"></div>
                </div>
                <div class="form-group"><label>Isi Satuan Kecil dalam 1 Satuan Besar</label><input type="number" id="m-b-conv" value="1"></div>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn btn-primary" style="flex:1" onclick="saveBarang()">Simpan Produk</button> 
                    <button class="btn" style="flex:1" onclick="closeModal()">Batal</button>
                </div>`;
            } else if(mode === 'transaksi') {
                const {data:items} = await sb.from('master_items').select('*');
                const {data:gudangs} = await sb.from('warehouses').select('*');
                content.innerHTML = `<h3>Barang ${extra.type==='IN'?'Masuk':'Keluar'}</h3><br>
                <div class="form-group"><label>Pilih Barang</label><select id="t-item">${items.map(i=>`<option value="${i.id}">${i.name}</option>`).join('')}</select></div>
                <div class="form-group"><label>Lokasi Gudang</label><select id="t-wh">${gudangs.map(g=>`<option value="${g.id}">${g.name}</option>`).join('')}</select></div>
                <div class="form-group"><label>Kuantitas</label><input type="number" id="t-qty" value="1"></div>
                <div class="form-group"><label>Pilih Satuan Input</label><select id="t-unit"><option value="small">Satuan Kecil (Eceran)</option><option value="big">Satuan Besar</option></select></div>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn ${extra.type==='IN'?'btn-success':'btn-danger'}" style="flex:1" onclick="processTransaction('${extra.type}')">Konfirmasi</button> 
                    <button class="btn" style="flex:1" onclick="closeModal()">Batal</button>
                </div>`;
            }
        }

        async function processTransaction(type) {
            const itemId = document.getElementById('t-item').value;
            const whId = document.getElementById('t-wh').value;
            const qty = parseInt(document.getElementById('t-qty').value);
            const isBig = document.getElementById('t-unit').value === 'big';

            const {data:item} = await sb.from('master_items').select('*').eq('id', itemId).single();
            const totalSmall = isBig ? (qty * item.conversion) : qty;
            const unitName = isBig ? item.unit_big : item.unit_small;

            const {data:stockRecord} = await sb.from('inventory_stocks').select('stock').eq('item_id', itemId).eq('warehouse_id', whId).maybeSingle();
            const currentWhStock = stockRecord ? stockRecord.stock : 0;

            if(type === 'OUT' && currentWhStock < totalSmall) return toast('Stok gudang tidak mencukupi!', 'error');

            await sb.from('transactions').insert([{ 
                item_id: itemId, warehouse_id: whId, type, qty, 
                unit: unitName, total_small_unit: totalSmall 
            }]);

            const newWhStock = type === 'IN' ? (currentWhStock + totalSmall) : (currentWhStock - totalSmall);
            if(stockRecord) {
                await sb.from('inventory_stocks').update({ stock: newWhStock }).eq('item_id', itemId).eq('warehouse_id', whId);
            } else {
                await sb.from('inventory_stocks').insert([{ item_id: itemId, warehouse_id: whId, stock: newWhStock }]);
            }

            const newGlobalStock = type === 'IN' ? (item.current_stock + totalSmall) : (item.current_stock - totalSmall);
            await sb.from('master_items').update({ current_stock: newGlobalStock }).eq('id', itemId);

            toast('Transaksi berhasil'); closeModal(); switchSection(type === 'IN' ? 'masuk' : 'keluar');
        }

        async function saveGudang() {
            const name = document.getElementById('m-g-name').value;
            const loc = document.getElementById('m-g-loc').value;
            if(!name) return;
            await sb.from('warehouses').insert([{ name, location: loc }]);
            closeModal(); fetchGudang();
        }

        async function saveBarang() {
            const n = document.getElementById('m-b-name').value;
            const b = document.getElementById('m-b-big').value;
            const s = document.getElementById('m-b-small').value;
            const c = parseInt(document.getElementById('m-b-conv').value);
            await sb.from('master_items').insert([{ name:n, unit_big:b, unit_small:s, conversion:c }]);
            closeModal(); fetchBarang();
        }

        async function syncFilterGudang() {
            const { data } = await sb.from('warehouses').select('*');
            const select = document.getElementById('filter-stok-gudang');
            const current = select.value;
            select.innerHTML = '<option value="all">Semua Gudang</option>' + 
                data.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            select.value = current;
        }

        async function loadDashboard() {
            const { count: whCount } = await sb.from('warehouses').select('*', { count: 'exact', head: true });
            const { count: itCount } = await sb.from('master_items').select('*', { count: 'exact', head: true });
            document.getElementById('stat-warehouses').innerText = whCount || 0;
            document.getElementById('stat-items').innerText = itCount || 0;

            const { data: recent } = await sb.from('transactions').select('*, master_items(name, unit_small), warehouses(name)').order('created_at', {ascending:false}).limit(5);
            document.getElementById('table-recent').querySelector('tbody').innerHTML = recent?.map(r => `
                <tr><td>${new Date(r.created_at).toLocaleTimeString()}</td><td><strong>${r.master_items?.name}</strong></td>
                <td><span class="badge ${r.type==='IN'?'badge-success':'badge-danger'}">${r.type}</span></td>
                <td>${r.warehouses?.name}</td><td>${r.total_small_unit} ${r.master_items?.unit_small}</td></tr>
            `).join('') || '<tr><td colspan="5">Belum ada aktivitas</td></tr>';
        }

        async function deleteData(table, id, callback) {
            if(confirm('Hapus data ini?')) { await sb.from(table).delete().eq('id', id); callback(); }
        }

        function closeModal() { document.getElementById('modal-overlay').style.display='none'; }
        
        function saveConfig() {
            localStorage.setItem('inv_sb_url', document.getElementById('cfg-url').value);
            localStorage.setItem('inv_sb_key', document.getElementById('cfg-key').value);
            init(); toast('Tersimpan');
        }

        function init() {
            const url = localStorage.getItem('inv_sb_url');
            const key = localStorage.getItem('inv_sb_key');
            if(url && key) {
                sb = supabase.createClient(url, key);
                document.getElementById('cfg-url').value = url;
                document.getElementById('cfg-key').value = key;
                document.getElementById('db-status').innerHTML = '<span class="badge badge-success">Online</span>';
                loadDashboard();
            } else { switchSection('settings'); }
        }

        window.onload = init;
    </script>
</body>
</html>
