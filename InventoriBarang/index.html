<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Inventori Multi-Perusahaan</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #f8f9fa;
            --dark: #1e293b;
            --gray: #64748b;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; }
        body { background-color: #f1f5f9; color: var(--dark); min-height: 100vh; overflow-x: hidden; }

        /* Login Page Styles */
        #login-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 20px; width: 100%; max-width: 400px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); text-align: center;
        }
        .login-logo {
            width: 70px; height: 70px; background: var(--primary); color: white;
            border-radius: 15px; display: flex; align-items: center; justify-content: center;
            font-size: 2rem; margin: 0 auto 20px;
        }
        .login-card h2 { margin-bottom: 10px; font-weight: 800; color: var(--dark); }
        .login-card p { color: var(--gray); margin-bottom: 30px; font-size: 0.9rem; }
        
        .form-group { text-align: left; margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.85rem; color: var(--gray); }
        .form-group select, .form-group input {
            width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px;
            font-size: 1rem; transition: all 0.2s; outline: none;
        }
        .form-group select:focus, .form-group input:focus { border-color: var(--primary); }

        .btn-login {
            width: 100%; padding: 14px; background: var(--primary); color: white;
            border: none; border-radius: 12px; font-size: 1rem; font-weight: 700;
            cursor: pointer; transition: 0.3s;
        }
        .btn-login:hover { background: var(--primary-dark); transform: translateY(-2px); }

        /* Sidebar Styles */
        .sidebar {
            width: 280px; background: var(--dark); color: white; height: 100vh;
            position: fixed; left: 0; top: 0; padding: 25px 0; z-index: 100;
        }
        .sidebar-header { padding: 0 25px 25px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .sidebar-header h1 { font-size: 1.4rem; font-weight: 800; letter-spacing: -0.5px; }
        .user-profile { padding: 15px 25px; background: rgba(255,255,255,0.05); margin: 0 15px 20px; border-radius: 12px; }
        .user-profile .name { display: block; font-weight: 600; font-size: 0.9rem; color: #fff; }
        .user-profile .role { font-size: 0.75rem; color: var(--success); }

        .nav-link {
            padding: 12px 25px; display: flex; align-items: center; gap: 15px;
            color: #94a3b8; text-decoration: none; cursor: pointer; transition: 0.2s;
        }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.08); color: white; }
        .nav-link.active { border-left: 4px solid var(--primary); background: rgba(67, 97, 238, 0.1); color: var(--primary); }
        
        /* Main Content */
        .main { margin-left: 280px; padding: 40px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 35px; }
        .header-top h2 { font-size: 1.75rem; font-weight: 800; }

        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .stat-box { background: white; padding: 25px; border-radius: 20px; box-shadow: var(--shadow); }
        .stat-box .icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 15px; }
        .stat-box .label { color: var(--gray); font-size: 0.9rem; font-weight: 500; }
        .stat-box .value { font-size: 1.8rem; font-weight: 800; margin-top: 5px; }

        .card { background: white; border-radius: 20px; padding: 30px; box-shadow: var(--shadow); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 15px; color: var(--gray); font-size: 0.85rem; text-transform: uppercase; border-bottom: 2px solid #f1f5f9; }
        td { padding: 18px 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; }

        .badge { padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; }
        .badge-in { background: #dcfce7; color: #166534; }
        .badge-out { background: #fee2e2; color: #991b1b; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.5); display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal { background: white; padding: 35px; border-radius: 24px; width: 100%; max-width: 500px; }
        
        .btn { padding: 12px 24px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        #toast {
            position: fixed; bottom: 30px; right: 30px; padding: 16px 24px;
            background: var(--dark); color: white; border-radius: 12px;
            display: none; z-index: 10000; box-shadow: var(--shadow);
        }
    </style>
</head>
<body>

    <!-- HALAMAN LOGIN -->
    <div id="login-page">
        <div class="login-card">
            <div class="login-logo"><i class="fas fa-boxes-stacked"></i></div>
            <h2>Inventori Pro</h2>
            <p>Silahkan masuk untuk mengelola stok Anda</p>
            
            <div class="form-group">
                <label>Pilih Perusahaan</label>
                <select id="login-company">
                    <option value="C1">PT. Obi Sinar Timur</option>
                    <option value="C2">PT. Halmahera Jaya Feronikel</option>
                    <option value="C3">PT. Karunia Permai Sentosa</option>
                </select>
            </div>
            <div class="form-group">
                <label>Kata Sandi</label>
                <input type="password" id="login-password" placeholder="Masukkan kata sandi">
            </div>
            <button class="btn-login" onclick="attemptLogin()">Masuk Sekarang</button>
            <p id="login-error" style="color: var(--danger); margin-top: 15px; display: none; font-weight: 600;"></p>
        </div>
    </div>

    <!-- APLIKASI UTAMA -->
    <div id="app-content" style="display: none;">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-layer-group"></i> INV-PRO</h1>
            </div>
            <div class="user-profile">
                <span class="name" id="display-company-name">Memuat...</span>
                <span class="role">Administrator Panel</span>
            </div>
            <nav>
                <div class="nav-link active" onclick="showTab('dashboard', this)"><i class="fas fa-home"></i> Dashboard</div>
                <div class="nav-link" onclick="showTab('items', this)"><i class="fas fa-box"></i> Data Barang</div>
                <div class="nav-link" onclick="showTab('warehouses', this)"><i class="fas fa-warehouse"></i> Gudang</div>
                <div class="nav-link" onclick="showTab('transactions', this)"><i class="fas fa-exchange-alt"></i> Riwayat</div>
                <div class="nav-link" onclick="showTab('settings', this)"><i class="fas fa-database"></i> Koneksi DB</div>
                <div class="nav-link" style="margin-top: 40px; color: var(--danger);" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Keluar Sistem
                </div>
            </nav>
        </div>

        <div class="main">
            <!-- Dashboard Tab -->
            <div id="tab-dashboard" class="tab-content">
                <div class="header-top">
                    <h2>Ringkasan Bisnis</h2>
                    <div id="status-db"><span class="badge" style="background: #fee2e2; color: #991b1b;">Offline</span></div>
                </div>
                <div class="stats-container">
                    <div class="stat-box">
                        <div class="icon" style="background: #e0e7ff; color: var(--primary);"><i class="fas fa-shopping-cart"></i></div>
                        <div class="label">Total Jenis Barang</div>
                        <div class="value" id="stat-total-items">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="icon" style="background: #dcfce7; color: var(--success);"><i class="fas fa-arrow-trend-up"></i></div>
                        <div class="label">Barang Masuk (Bulan Ini)</div>
                        <div class="value" id="stat-in">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="icon" style="background: #fee2e2; color: var(--danger);"><i class="fas fa-arrow-trend-down"></i></div>
                        <div class="label">Barang Keluar (Bulan Ini)</div>
                        <div class="value" id="stat-out">0</div>
                    </div>
                </div>
                <div class="card">
                    <h3>Aktivitas Terbaru</h3>
                    <table id="recent-table">
                        <thead><tr><th>Waktu</th><th>Item</th><th>Tipe</th><th>Gudang</th><th>Jumlah</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Items Tab -->
            <div id="tab-items" class="tab-content" style="display:none;">
                <div class="header-top">
                    <h2>Daftar Barang</h2>
                    <button class="btn btn-primary" onclick="openModal('add-item')"><i class="fas fa-plus"></i> Tambah Barang</button>
                </div>
                <div class="card">
                    <table id="items-table">
                        <thead><tr><th>Nama Barang</th><th>Konversi</th><th>Stok Saat Ini</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Warehouses Tab -->
            <div id="tab-warehouses" class="tab-content" style="display:none;">
                <div class="header-top">
                    <h2>Lokasi Gudang</h2>
                    <button class="btn btn-primary" onclick="openModal('add-warehouse')"><i class="fas fa-plus"></i> Gudang Baru</button>
                </div>
                <div class="card">
                    <table id="warehouse-table">
                        <thead><tr><th>Nama Gudang</th><th>Alamat/Lokasi</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="tab-transactions" class="tab-content" style="display:none;">
                <div class="header-top">
                    <h2>Riwayat Pergerakan Barang</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="openModal('trans-in')">Input Masuk</button>
                        <button class="btn btn-danger" onclick="openModal('trans-out')">Input Keluar</button>
                    </div>
                </div>
                <div class="card">
                    <table id="trans-table">
                        <thead><tr><th>Tanggal</th><th>Item</th><th>Gudang</th><th>Tipe</th><th>Jumlah</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-content" style="display:none;">
                <div class="header-top"><h2>Koneksi Supabase</h2></div>
                <div class="card" style="max-width: 600px;">
                    <p style="margin-bottom: 20px; color: var(--gray);">Masukkan detail koneksi Supabase Anda untuk mengaktifkan sinkronisasi database cloud.</p>
                    <div class="form-group"><label>Project URL</label><input type="text" id="db-url" placeholder="https://xyz.supabase.co"></div>
                    <div class="form-group"><label>API Key (Anon Key)</label><input type="password" id="db-key" placeholder="eyJhbGciOiJIUzI1..."></div>
                    <button class="btn btn-primary" onclick="saveConfig()">Simpan & Hubungkan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal" id="modal-content"></div>
    </div>

    <div id="toast"></div>

    <script>
        let sb = null;
        let auth = { companyId: '', companyName: '' };

        // --- AUTH LOGIC ---
        function attemptLogin() {
            const compId = document.getElementById('login-company').value;
            const compName = document.getElementById('login-company').options[document.getElementById('login-company').selectedIndex].text;
            const pass = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');

            // Simulasi keamanan sederhana
            if (pass === "admin123") {
                auth = { companyId: compId, companyName: compName };
                localStorage.setItem('inv_auth', JSON.stringify(auth));
                showApp();
            } else {
                errorEl.innerText = "Kata sandi salah! (Coba: admin123)";
                errorEl.style.display = "block";
            }
        }

        function logout() {
            localStorage.removeItem('inv_auth');
            location.reload();
        }

        function checkAuth() {
            const saved = localStorage.getItem('inv_auth');
            if (saved) {
                auth = JSON.parse(saved);
                showApp();
            }
        }

        function showApp() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('display-company-name').innerText = auth.companyName;
            initSupabase();
        }

        // --- NAVIGATION ---
        function showTab(tabId, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById('tab-' + tabId).style.display = 'block';
            el.classList.add('active');
            
            if (sb) {
                if (tabId === 'dashboard') loadDashboard();
                if (tabId === 'items') loadItems();
                if (tabId === 'warehouses') loadWarehouses();
                if (tabId === 'transactions') loadTransactions();
            }
        }

        // --- DATABASE LOGIC ---
        function initSupabase() {
            const url = localStorage.getItem('inv_url');
            const key = localStorage.getItem('inv_key');
            if (url && key) {
                sb = supabase.createClient(url, key);
                document.getElementById('db-url').value = url;
                document.getElementById('db-key').value = key;
                document.getElementById('status-db').innerHTML = '<span class="badge" style="background: #dcfce7; color: #166534;">Connected</span>';
                loadDashboard();
            } else {
                showTab('settings', document.querySelectorAll('.nav-link')[4]);
            }
        }

        async function loadDashboard() {
            const { count: itemsCount } = await sb.from('master_items').select('*', { count: 'exact', head: true }).eq('company_id', auth.companyId);
            document.getElementById('stat-total-items').innerText = itemsCount || 0;

            const { data: recent } = await sb.from('transactions')
                .select('*, master_items!inner(name, unit_small, company_id), warehouses(name)')
                .eq('master_items.company_id', auth.companyId)
                .order('created_at', {ascending: false}).limit(5);

            document.getElementById('recent-table').querySelector('tbody').innerHTML = recent?.map(r => `
                <tr>
                    <td>${new Date(r.created_at).toLocaleTimeString()}</td>
                    <td><strong>${r.master_items.name}</strong></td>
                    <td><span class="badge ${r.type==='IN'?'badge-in':'badge-out'}">${r.type}</span></td>
                    <td>${r.warehouses?.name || '-'}</td>
                    <td>${r.total_small_unit} ${r.master_items.unit_small}</td>
                </tr>
            `).join('') || '<tr><td colspan="5" align="center">Belum ada aktivitas</td></tr>';
        }

        async function loadItems() {
            const { data } = await sb.from('master_items').select('*').eq('company_id', auth.companyId).order('name');
            document.getElementById('items-table').querySelector('tbody').innerHTML = data?.map(i => `
                <tr>
                    <td><strong>${i.name}</strong></td>
                    <td>1 ${i.unit_big} = ${i.conversion} ${i.unit_small}</td>
                    <td><span style="font-weight:800; color:var(--primary); font-size:1.1rem;">${i.current_stock}</span> ${i.unit_small}</td>
                    <td><button class="btn btn-danger" style="padding:5px 10px;" onclick="deleteItem('${i.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('') || '';
        }

        async function loadWarehouses() {
            const { data } = await sb.from('warehouses').select('*').eq('company_id', auth.companyId).order('name');
            document.getElementById('warehouse-table').querySelector('tbody').innerHTML = data?.map(w => `
                <tr>
                    <td><strong>${w.name}</strong></td>
                    <td>${w.location || '-'}</td>
                    <td><button class="btn btn-danger" style="padding:5px 10px;" onclick="deleteWarehouse('${w.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('') || '';
        }

        async function loadTransactions() {
            const { data } = await sb.from('transactions')
                .select('*, master_items!inner(name, unit_small, company_id), warehouses(name)')
                .eq('master_items.company_id', auth.companyId)
                .order('created_at', {ascending: false});

            document.getElementById('trans-table').querySelector('tbody').innerHTML = data?.map(t => `
                <tr>
                    <td>${new Date(t.created_at).toLocaleDateString()}</td>
                    <td><strong>${t.master_items.name}</strong></td>
                    <td>${t.warehouses?.name || '-'}</td>
                    <td><span class="badge ${t.type==='IN'?'badge-in':'badge-out'}">${t.type}</span></td>
                    <td>${t.total_small_unit} ${t.master_items.unit_small}</td>
                </tr>
            `).join('') || '';
        }

        // --- ACTIONS ---
        async function openModal(type) {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            overlay.style.display = 'flex';

            if (type === 'add-item') {
                content.innerHTML = `
                    <h3>Tambah Barang Baru</h3><br>
                    <div class="form-group"><label>Nama Barang</label><input type="text" id="m-name"></div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                        <div class="form-group"><label>Satuan Besar</label><input type="text" id="m-big" placeholder="Contoh: Dus"></div>
                        <div class="form-group"><label>Satuan Kecil</label><input type="text" id="m-small" placeholder="Contoh: Pcs"></div>
                    </div>
                    <div class="form-group"><label>Isi per Satuan Besar</label><input type="number" id="m-conv" value="1"></div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-primary" onclick="saveItem()">Simpan</button>
                        <button class="btn" style="background:#e2e8f0" onclick="closeModal()">Batal</button>
                    </div>
                `;
            } else if (type === 'add-warehouse') {
                content.innerHTML = `
                    <h3>Gudang Baru</h3><br>
                    <div class="form-group"><label>Nama Gudang</label><input type="text" id="m-w-name"></div>
                    <div class="form-group"><label>Alamat/Keterangan</label><input type="text" id="m-w-loc"></div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-primary" onclick="saveWarehouse()">Simpan</button>
                        <button class="btn" style="background:#e2e8f0" onclick="closeModal()">Batal</button>
                    </div>
                `;
            } else if (type.startsWith('trans-')) {
                const mode = type === 'trans-in' ? 'IN' : 'OUT';
                const {data:items} = await sb.from('master_items').select('*').eq('company_id', auth.companyId);
                const {data:whs} = await sb.from('warehouses').select('*').eq('company_id', auth.companyId);
                
                content.innerHTML = `
                    <h3>Transaksi ${mode === 'IN' ? 'Masuk' : 'Keluar'}</h3><br>
                    <div class="form-group"><label>Pilih Barang</label><select id="t-item">${items.map(i=>`<option value="${i.id}">${i.name}</option>`).join('')}</select></div>
                    <div class="form-group"><label>Gudang Tujuan</label><select id="t-wh">${whs.map(w=>`<option value="${w.id}">${w.name}</option>`).join('')}</select></div>
                    <div class="form-group"><label>Jumlah</label><input type="number" id="t-qty" value="1"></div>
                    <div class="form-group"><label>Satuan</label><select id="t-unit"><option value="kecil">Satuan Kecil</option><option value="besar">Satuan Besar</option></select></div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn ${mode==='IN'?'btn-success':'btn-danger'}" onclick="saveTransaction('${mode}')">Proses</button>
                        <button class="btn" style="background:#e2e8f0" onclick="closeModal()">Batal</button>
                    </div>
                `;
            }
        }

        async function saveItem() {
            const name = document.getElementById('m-name').value;
            const big = document.getElementById('m-big').value;
            const small = document.getElementById('m-small').value;
            const conv = parseInt(document.getElementById('m-conv').value);
            
            await sb.from('master_items').insert([{ 
                name, unit_big: big, unit_small: small, conversion: conv, company_id: auth.companyId 
            }]);
            closeModal(); loadItems(); toast('Barang berhasil disimpan');
        }

        async function saveWarehouse() {
            const name = document.getElementById('m-w-name').value;
            const loc = document.getElementById('m-w-loc').value;
            await sb.from('warehouses').insert([{ name, location: loc, company_id: auth.companyId }]);
            closeModal(); loadWarehouses(); toast('Gudang berhasil disimpan');
        }

        async function saveTransaction(type) {
            const itemId = document.getElementById('t-item').value;
            const whId = document.getElementById('t-wh').value;
            const qty = parseInt(document.getElementById('t-qty').value);
            const unitType = document.getElementById('t-unit').value;
            
            const { data: item } = await sb.from('master_items').select('*').eq('id', itemId).single();
            const totalSmall = unitType === 'besar' ? (qty * item.conversion) : qty;
            
            // Validasi stok jika keluar
            if (type === 'OUT' && item.current_stock < totalSmall) {
                return toast('Gagal: Stok tidak mencukupi!', 'error');
            }

            // Simpan Transaksi
            await sb.from('transactions').insert([{
                item_id: itemId, warehouse_id: whId, type: type, 
                qty: qty, unit: unitType === 'besar' ? item.unit_big : item.unit_small,
                total_small_unit: totalSmall, company_id: auth.companyId
            }]);

            // Update Stok Master
            const newStock = type === 'IN' ? (item.current_stock + totalSmall) : (item.current_stock - totalSmall);
            await sb.from('master_items').update({ current_stock: newStock }).eq('id', itemId);

            closeModal(); loadTransactions(); toast('Transaksi berhasil dicatat');
        }

        async function deleteItem(id) { if(confirm('Hapus barang ini?')) { await sb.from('master_items').delete().eq('id', id); loadItems(); } }
        async function deleteWarehouse(id) { if(confirm('Hapus gudang ini?')) { await sb.from('warehouses').delete().eq('id', id); loadWarehouses(); } }

        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        function saveConfig() {
            localStorage.setItem('inv_url', document.getElementById('db-url').value);
            localStorage.setItem('inv_key', document.getElementById('db-key').value);
            toast('Konfigurasi disimpan. Memuat ulang...');
            setTimeout(() => location.reload(), 1500);
        }

        function toast(msg, type='success') {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.background = type === 'error' ? 'var(--danger)' : 'var(--dark)';
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        window.onload = checkAuth;
    </script>
</body>
</html>
