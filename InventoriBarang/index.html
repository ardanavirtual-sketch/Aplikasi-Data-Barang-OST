<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Inventori</title>
    <!-- Load Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --gray: #95a5a6;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', sans-serif;
        }

        body {
            background-color: #f0f2f5;
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styling */
        .sidebar {
            width: 260px;
            background: var(--dark);
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100%;
            z-index: 100;
        }

        .sidebar-brand {
            padding: 0 20px 30px;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            padding: 12px 25px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
            color: #bdc3c7;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item i { width: 20px; text-align: center; }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            flex: 1;
            padding: 30px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary);
        }

        .stat-card h3 { font-size: 0.9rem; color: var(--gray); margin-bottom: 10px; }
        .stat-card p { font-size: 1.8rem; font-weight: bold; color: var(--dark); }
        .stat-card.in { border-left-color: var(--success); }
        .stat-card.out { border-left-color: var(--danger); }

        /* Tables & UI Components */
        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            text-align: left;
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 2px solid #edf2f7;
            color: var(--dark);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #edf2f7;
            vertical-align: middle;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-success { background: #d4edda; color: #155724; }
        .badge-danger { background: #f8d7da; color: #721c24; }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.85rem; }

        /* Modal */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            position: relative;
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        /* Notifications */
        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            display: none;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-brand">
            <i class="fas fa-boxes-stacked"></i> INV-APP
        </div>
        <ul class="nav-menu">
            <li class="nav-item active" id="nav-dashboard" onclick="switchSection('dashboard')">
                <i class="fas fa-chart-line"></i> Dashboard
            </li>
            <li class="nav-item" id="nav-barang" onclick="switchSection('barang')">
                <i class="fas fa-box"></i> Master Barang
            </li>
            <li class="nav-item" id="nav-masuk" onclick="switchSection('masuk')">
                <i class="fas fa-arrow-down" style="color: var(--success)"></i> Barang Masuk
            </li>
            <li class="nav-item" id="nav-keluar" onclick="switchSection('keluar')">
                <i class="fas fa-arrow-up" style="color: var(--danger)"></i> Barang Keluar
            </li>
            <li class="nav-item" id="nav-settings" onclick="switchSection('settings')">
                <i class="fas fa-cog"></i> Pengaturan API
            </li>
        </ul>
    </div>

    <div class="main-content">
        <!-- Section Dashboard -->
        <div id="section-dashboard" class="app-section">
            <header>
                <h2>Ringkasan Inventori</h2>
                <div id="db-status"><span class="badge badge-danger">Disconnected</span></div>
            </header>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Jenis Item</h3>
                    <p id="stat-total-items">0</p>
                </div>
                <div class="stat-card in">
                    <h3>Akumulasi Masuk</h3>
                    <p id="stat-trans-in">0</p>
                    <small id="stat-today-in" style="color: var(--success)">Hari ini: 0</small>
                </div>
                <div class="stat-card out">
                    <h3>Akumulasi Keluar</h3>
                    <p id="stat-trans-out">0</p>
                    <small id="stat-today-out" style="color: var(--danger)">Hari ini: 0</small>
                </div>
            </div>

            <div class="card">
                <h3>Monitor Stok Rendah</h3>
                <table id="table-low-stock">
                    <thead>
                        <tr>
                            <th>Nama Barang</th>
                            <th>Stok Sisa</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Section Master Barang -->
        <div id="section-barang" class="app-section" style="display:none;">
            <header>
                <h2>Master Data Barang</h2>
                <button class="btn btn-primary" onclick="openModal('barang')">
                    <i class="fas fa-plus"></i> Tambah Barang Baru
                </button>
            </header>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Nama Barang</th>
                            <th>Satuan Besar</th>
                            <th>Satuan Kecil</th>
                            <th>Konversi</th>
                            <th>Stok Terkini</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="body-master-barang"></tbody>
                </table>
            </div>
        </div>

        <!-- Section Barang Masuk -->
        <div id="section-masuk" class="app-section" style="display:none;">
            <header>
                <h2>Riwayat Barang Masuk (IN)</h2>
                <button class="btn btn-success" onclick="openModal('transaksi', {type: 'IN'})">
                    <i class="fas fa-plus"></i> Input Barang Masuk
                </button>
            </header>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Waktu & Tanggal</th>
                            <th>Nama Barang</th>
                            <th>Jumlah</th>
                            <th>Total (Eceran)</th>
                            <th>Opsi</th>
                        </tr>
                    </thead>
                    <tbody id="body-transaksi-masuk"></tbody>
                </table>
            </div>
        </div>

        <!-- Section Barang Keluar -->
        <div id="section-keluar" class="app-section" style="display:none;">
            <header>
                <h2>Riwayat Barang Keluar (OUT)</h2>
                <button class="btn btn-danger" onclick="openModal('transaksi', {type: 'OUT'})">
                    <i class="fas fa-minus"></i> Input Barang Keluar
                </button>
            </header>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Waktu & Tanggal</th>
                            <th>Nama Barang</th>
                            <th>Jumlah</th>
                            <th>Total (Eceran)</th>
                            <th>Opsi</th>
                        </tr>
                    </thead>
                    <tbody id="body-transaksi-keluar"></tbody>
                </table>
            </div>
        </div>

        <!-- Section Settings -->
        <div id="section-settings" class="app-section" style="display:none;">
            <header><h2>Konfigurasi Supabase</h2></header>
            <div class="card">
                <div class="form-group">
                    <label>Supabase URL</label>
                    <input type="text" id="sb-url" placeholder="https://xxxx.supabase.co">
                </div>
                <div class="form-group">
                    <label>Supabase Anon Key</label>
                    <input type="password" id="sb-key" placeholder="eyJhbGciOiJIUzI1NiI...">
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Simpan & Hubungkan</button>
            </div>
        </div>
    </div>

    <!-- Modal Container -->
    <div id="modal-overlay">
        <div class="modal-content" id="modal-content"></div>
    </div>

    <div id="toast"></div>

    <script>
        let supabaseClient = null;
        let currentEditingId = null;

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.background = type === 'success' ? '#2ecc71' : '#e74c3c';
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }

        function switchSection(sectionId) {
            document.querySelectorAll('.app-section').forEach(s => s.style.display = 'none');
            document.getElementById(`section-${sectionId}`).style.display = 'block';
            
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(`nav-${sectionId}`).classList.add('active');

            if (supabaseClient) {
                if (sectionId === 'barang') fetchMasterBarang();
                if (sectionId === 'masuk') fetchTransaksi('IN');
                if (sectionId === 'keluar') fetchTransaksi('OUT');
                if (sectionId === 'dashboard') updateDashboard();
            }
        }

        function saveSettings() {
            const url = document.getElementById('sb-url').value;
            const key = document.getElementById('sb-key').value;
            localStorage.setItem('sb_url', url);
            localStorage.setItem('sb_key', key);
            initSupabase();
            showToast('Konfigurasi Berhasil!');
        }

        function initSupabase() {
            const url = localStorage.getItem('sb_url');
            const key = localStorage.getItem('sb_key');
            if (url && key) {
                supabaseClient = supabase.createClient(url, key);
                document.getElementById('sb-url').value = url;
                document.getElementById('sb-key').value = key;
                document.getElementById('db-status').innerHTML = '<span class="badge badge-success">Terhubung</span>';
                updateDashboard();
            } else {
                switchSection('settings');
            }
        }

        async function updateDashboard() {
            if (!supabaseClient) return;
            const { count } = await supabaseClient.from('master_items').select('*', { count: 'exact', head: true });
            document.getElementById('stat-total-items').innerText = count || 0;

            const { data: allTrans } = await supabaseClient.from('transactions').select('type, total_small_unit, created_at');
            const today = new Date().toISOString().split('T')[0];
            let tin = 0, tout = 0, din = 0, dout = 0;

            allTrans?.forEach(t => {
                const isToday = t.created_at.startsWith(today);
                if (t.type === 'IN') { tin += t.total_small_unit; if(isToday) din += t.total_small_unit; }
                else { tout += t.total_small_unit; if(isToday) dout += t.total_small_unit; }
            });

            document.getElementById('stat-trans-in').innerText = tin;
            document.getElementById('stat-trans-out').innerText = tout;
            document.getElementById('stat-today-in').innerText = `Hari ini: ${din}`;
            document.getElementById('stat-today-out').innerText = `Hari ini: ${dout}`;

            const { data: low } = await supabaseClient.from('master_items').select('*').lte('current_stock', 10);
            const tbody = document.querySelector('#table-low-stock tbody');
            tbody.innerHTML = low?.map(item => `
                <tr><td>${item.name}</td><td><strong>${item.current_stock}</strong> ${item.unit_small}</td>
                <td><span class="badge badge-danger">Segera Isi</span></td></tr>
            `).join('') || '<tr><td colspan="3" style="text-align:center">Stok aman.</td></tr>';
        }

        async function fetchMasterBarang() {
            const { data } = await supabaseClient.from('master_items').select('*').order('name');
            document.getElementById('body-master-barang').innerHTML = data?.map(item => `
                <tr><td>${item.name}</td><td>${item.unit_big}</td><td>${item.unit_small}</td><td>1:${item.conversion}</td>
                <td><strong>${item.current_stock}</strong> ${item.unit_small}</td>
                <td><button class="btn btn-sm btn-primary" onclick="editBarang('${item.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger" onclick="deleteBarang('${item.id}')"><i class="fas fa-trash"></i></button></td></tr>
            `).join('') || '';
        }

        async function fetchTransaksi(filterType) {
            const { data } = await supabaseClient.from('transactions')
                .select('*, master_items(name, unit_small)')
                .eq('type', filterType)
                .order('created_at', { ascending: false });
            
            const targetId = filterType === 'IN' ? 'body-transaksi-masuk' : 'body-transaksi-keluar';
            document.getElementById(targetId).innerHTML = data?.map(t => `
                <tr><td>${new Date(t.created_at).toLocaleString('id-ID')}</td><td>${t.master_items?.name || 'Item Dihapus'}</td>
                <td>${t.qty} ${t.unit}</td><td>${t.total_small_unit} ${t.master_items?.unit_small || ''}</td>
                <td><button class="btn btn-sm btn-danger" onclick="deleteTransaksi('${t.id}', '${t.item_id}', '${t.type}', ${t.total_small_unit})">
                <i class="fas fa-undo"></i> Batal</button></td></tr>
            `).join('') || '';
        }

        async function submitBarang() {
            const payload = {
                name: document.getElementById('f-name').value,
                unit_big: document.getElementById('f-big').value,
                unit_small: document.getElementById('f-small').value,
                conversion: parseInt(document.getElementById('f-conv').value),
            };
            const res = currentEditingId ? await supabaseClient.from('master_items').update(payload).eq('id', currentEditingId) : await supabaseClient.from('master_items').insert([payload]);
            if (res.error) showToast(res.error.message, 'error');
            else { showToast('Berhasil disimpan'); closeModal(); fetchMasterBarang(); }
        }

        async function submitTransaksi(type) {
            const itemId = document.getElementById('f-item-id').value;
            const qty = parseInt(document.getElementById('f-qty').value);
            const unitType = document.getElementById('f-unit-type').value;

            const { data: item } = await supabaseClient.from('master_items').select('*').eq('id', itemId).single();
            const totalSmall = unitType === 'big' ? (qty * item.conversion) : qty;
            const unitName = unitType === 'big' ? item.unit_big : item.unit_small;

            if(type === 'OUT' && item.current_stock < totalSmall) return showToast('Stok tidak cukup!', 'error');

            await supabaseClient.from('transactions').insert([{ item_id: itemId, type, qty, unit: unitName, total_small_unit: totalSmall }]);
            const newStock = type === 'IN' ? (item.current_stock + totalSmall) : (item.current_stock - totalSmall);
            await supabaseClient.from('master_items').update({ current_stock: newStock }).eq('id', itemId);

            showToast('Transaksi Berhasil');
            closeModal();
            fetchTransaksi(type);
        }

        async function deleteBarang(id) {
            if (confirm('Hapus barang ini?')) { await supabaseClient.from('master_items').delete().eq('id', id); fetchMasterBarang(); }
        }

        async function deleteTransaksi(id, itemId, type, amount) {
            if (!confirm('Batalkan transaksi ini?')) return;
            const { data: item } = await supabaseClient.from('master_items').select('current_stock').eq('id', itemId).single();
            if(item) {
                const rev = type === 'IN' ? (item.current_stock - amount) : (item.current_stock + amount);
                await supabaseClient.from('master_items').update({ current_stock: rev }).eq('id', itemId);
            }
            await supabaseClient.from('transactions').delete().eq('id', id);
            fetchTransaksi(type);
        }

        async function editBarang(id) {
            const { data } = await supabaseClient.from('master_items').select('*').eq('id', id).single();
            openModal('barang', data);
        }

        function openModal(type, data = null) {
            const content = document.getElementById('modal-content');
            currentEditingId = (type === 'barang' && data) ? data.id : null;
            document.getElementById('modal-overlay').style.display = 'flex';

            if (type === 'barang') {
                content.innerHTML = `<h3>${data ? 'Edit' : 'Tambah'} Barang</h3><br>
                    <div class="form-group"><label>Nama</label><input type="text" id="f-name" value="${data ? data.name : ''}"></div>
                    <div class="form-group"><label>Satuan Besar (Dus)</label><input type="text" id="f-big" value="${data ? data.unit_big : ''}"></div>
                    <div class="form-group"><label>Satuan Kecil (Pcs)</label><input type="text" id="f-small" value="${data ? data.unit_small : ''}"></div>
                    <div class="form-group"><label>Isi Per Satuan Besar</label><input type="number" id="f-conv" value="${data ? data.conversion : ''}"></div>
                    <div style="display:flex; gap:10px"><button class="btn btn-primary" onclick="submitBarang()">Simpan</button><button class="btn" onclick="closeModal()">Batal</button></div>`;
            } else if (type === 'transaksi') {
                loadTransaksiForm(data.type);
            }
        }

        async function loadTransaksiForm(type) {
            const { data: items } = await supabaseClient.from('master_items').select('id, name');
            document.getElementById('modal-content').innerHTML = `<h3>Input Barang ${type === 'IN' ? 'Masuk' : 'Keluar'}</h3><br>
                <div class="form-group"><label>Barang</label><select id="f-item-id">${items.map(i => `<option value="${i.id}">${i.name}</option>`).join('')}</select></div>
                <div class="form-group"><label>Jumlah</label><input type="number" id="f-qty" value="1" min="1"></div>
                <div class="form-group"><label>Satuan</label><select id="f-unit-type"><option value="big">Satuan Besar</option><option value="small">Satuan Kecil</option></select></div>
                <div style="display:flex; gap:10px"><button class="btn ${type === 'IN' ? 'btn-success' : 'btn-danger'}" onclick="submitTransaksi('${type}')">Proses</button>
                <button class="btn" onclick="closeModal()">Batal</button></div>`;
        }

        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
        window.onload = initSupabase;
    </script>
</body>
</html>
