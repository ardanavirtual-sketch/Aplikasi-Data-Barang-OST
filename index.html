<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InventPro - Barang Keluar Multi-Unit (Supabase View)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .sidebar { width: 280px; transition: transform 0.3s ease-in-out; z-index: 50; }
        .main-content { margin-left: 280px; }
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-280px); position: fixed; height: 100%; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
        }
        .bg-sidebar { background-color: #171c26; }
        .bg-sidebar-active { background-color: #272d3a; }
        .text-sidebar-inactive { color: #b0b4ba; }
        .text-sidebar-active { color: #ffffff; }
        .btn-primary { background-color: #f76807; color: white; }
        .btn-primary:hover { background-color: #e05e00; }
        /* Modal Backdrop */
        .modal-backdrop { z-index: 99; background-color: rgba(0, 0, 0, 0.5); }
        .modal-content { z-index: 100; }
    </style>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden">

    <button id="menu-toggle" class="lg:hidden fixed top-4 left-4 p-2 rounded-lg bg-gray-200 z-50">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
    </button>

    <div id="sidebar" class="sidebar bg-sidebar flex flex-col fixed h-full shadow-lg lg:relative lg:translate-x-0">
        <div class="p-6 text-white border-b border-gray-700/50">
            <h1 class="text-xl font-bold">InventPro</h1>
            <p class="text-xs text-gray-400">Inventory Management</p>
        </div>
        <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
            <p class="text-xs font-semibold uppercase text-gray-500/70 px-4 pt-4 pb-2">Menu Utama</p>
            <a href="#" class="flex items-center space-x-3 p-3 rounded-lg bg-sidebar-active text-sidebar-active font-semibold">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-1"></path></svg>
                <span>Barang Keluar</span>
            </a>
        </nav>
        <div class="p-4 text-xs text-gray-500/70 border-t border-gray-700/50">
            Â© 2024 InventPro v1.0
        </div>
    </div>

    <div class="main-content flex-1 flex flex-col overflow-hidden">
        
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shadow-sm">
            <h2 class="text-xl font-semibold text-gray-800 hidden sm:block">Pencatatan Barang Keluar</h2>
            <div class="flex items-center space-x-4 ml-auto">
                <span id="user-id-display" class="text-xs text-gray-500 truncate"></span>
                <button class="p-2 text-gray-500 hover:text-gray-700 relative">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1"></path></svg>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-6">
            
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <h1 class="text-2xl font-bold text-gray-800 flex items-center space-x-2 mb-4 sm:mb-0">
                    <svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(90deg);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                    <span>Riwayat Barang Keluar</span>
                </h1>
                
                <button id="open-modal-btn" class="btn-primary flex items-center space-x-2 px-4 py-2 rounded-lg font-semibold shadow-md hover:shadow-lg transition duration-200 w-full sm:w-auto">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    <span>Catat Barang Keluar</span>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-5 rounded-xl shadow-md flex justify-between items-center">
                    <span class="text-gray-500">Total Stok Global (Pcs/Botol)</span>
                    <span id="total-stok-display" class="text-2xl font-bold text-blue-600">Memuat...</span>
                </div>
            </div>

            <div class="bg-white p-4 sm:p-8 rounded-xl shadow-md">
                <h3 class="text-xl font-semibold mb-4">Daftar Barang Keluar</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produk</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah (Unit Kecil)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tujuan</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catatan</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-list" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="py-4 text-center text-gray-500">Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <div id="new-transaction-modal" class="modal-backdrop fixed inset-0 hidden items-center justify-center p-4">
        <div class="modal-content bg-white w-full max-w-4xl rounded-xl shadow-2xl p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-bold text-gray-800">Catat Barang Keluar (Batch)</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 border-r lg:pr-6">
                    <h4 class="text-lg font-semibold mb-3 text-gray-700">Tambah Item ke Draft</h4>
                    <form id="add-item-form" class="space-y-4">
                        <div>
                            <label for="product-select" class="block text-sm font-medium text-gray-700">Produk</label>
                            <select id="product-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                                <option value="">Pilih Produk</option>
                            </select>
                        </div>
                        <div>
                            <label for="jumlah-keluar" class="block text-sm font-medium text-gray-700">Jumlah Keluar (Unit Kecil)</label>
                            <input type="number" id="jumlah-keluar" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="1" required>
                            <p id="unit-kecil-display" class="mt-1 text-xs text-gray-500"></p>
                            <p id="stok-warning" class="mt-1 text-xs text-red-500 hidden font-semibold">Stok tidak cukup!</p>
                        </div>
                        <div>
                            <label for="tujuan" class="block text-sm font-medium text-gray-700">Tujuan/Pelanggan</label>
                            <input type="text" id="tujuan" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="Cth: Penjualan Toko A" required>
                        </div>
                        <button type="submit" class="w-full btn-primary px-4 py-2 rounded-lg font-semibold transition duration-200" id="add-item-btn">Tambahkan ke Draft</button>
                    </form>
                </div>

                <div class="lg:col-span-2">
                    <h4 class="text-lg font-semibold mb-3 text-gray-700">Draft Transaksi (<span id="draft-count">0</span> Item)</h4>
                    
                    <div id="draft-list-container" class="space-y-3 max-h-80 overflow-y-auto p-2 border rounded-md bg-gray-50 mb-4">
                        <p id="empty-draft-message" class="text-center text-gray-500 py-4">Draft kosong. Tambahkan item di samping.</p>
                        </div>

                    <div class="flex justify-between items-center pt-4 border-t">
                        <button id="clear-draft-btn" class="text-red-500 hover:text-red-700 text-sm disabled:opacity-50" disabled>Hapus Draft</button>
                        <button id="save-batch-btn" class="btn-primary px-6 py-3 rounded-lg font-bold disabled:opacity-50" disabled>
                            Simpan & Approve (<span id="save-count">0</span>)
                        </button>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <div id="toast-container" class="fixed bottom-4 right-4 space-y-2"></div>

    <script type="module">
        const { createClient } = supabase;

        // =================================================================
        // !! GANTI DENGAN URL DAN ANON KEY SUPABASE ANDA !!
        // =================================================================
        const supabaseUrl = 'https://iltqolfmvhzaiuagtoxt.supabase.co'; 
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsdHFvbGZtdmh6YWl1YWd0b3h0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNDE5MjQsImV4cCI6MjA4MDgxNzkyNH0.sGzEQjpKfy7fdw8KBNO7mVzKd2tuxqQaYAdRuTjHVMs'; 
        
        // Simulasikan UUID pengguna (Penting: Ganti dengan session.user.id jika menggunakan Supabase Auth)
        let supabaseClient, userId = '00000000-0000-0000-0000-000000000001'; 

        let products = [];
        let stockData = {}; // {produk_id: stok_aktual_unit_kecil}
        let draftTransactions = []; // State untuk input batch di sisi klien
        
        // --- SUPABASE INITIALIZATION ---
        function initializeSupabase() {
            try {
                supabaseClient = createClient(supabaseUrl, supabaseAnonKey);
                document.getElementById('user-id-display').textContent = `User ID: ${userId} (Simulasi)`;
                console.log("Supabase Client initialized for user:", userId);

                // Setelah inisialisasi, setup data dan listener
                setupData(); 
                setupListeners();

            } catch (error) {
                console.error("Error during Supabase initialization:", error);
                showToast("Gagal memuat aplikasi. Cek konfigurasi URL/Key Supabase Anda.", 'error');
            }
        }
        
        // --- DATA SETUP (SIMULASI MASTER DATA) ---
        async function setupData() {
            // Data mock produk awal (menggunakan SKU untuk checking duplikasi)
            const mockProducts = [
                { nama_produk: 'Air Mineral 600ml', sku: 'AM-600', unit_besar: 'Dus', unit_kecil: 'Botol', konversi_kecil: 24, initial_stok_dus: 50 },
                { nama_produk: 'Soft Drink Kaleng', sku: 'SD-CLG', unit_besar: 'Pack', unit_kecil: 'Kaleng', konversi_kecil: 6, initial_stok_dus: 100 },
                { nama_produk: 'Mie Instan Kuah', sku: 'MI-KUH', unit_besar: 'Karton', unit_kecil: 'Bungkus', konversi_kecil: 40, initial_stok_dus: 30 },
            ];

            try {
                for (const item of mockProducts) {
                    // Cek apakah produk sudah ada berdasarkan SKU
                    const { data: existingProd } = await supabaseClient
                        .from('produk')
                        .select('id')
                        .eq('sku', item.sku);

                    if (!existingProd || existingProd.length === 0) {
                        // 1. Insert Produk baru
                        const { data: newProd, error: insertError } = await supabaseClient.from('produk').insert({
                            nama_produk: item.nama_produk,
                            sku: item.sku,
                            unit_besar: item.unit_besar,
                            unit_kecil: item.unit_kecil,
                            konversi_kecil: item.konversi_kecil,
                        }).select('id'); // Ambil ID (UUID) yang baru dibuat

                        if (insertError) throw insertError;

                        const newId = newProd[0].id;
                        
                        // 2. Tambahkan Barang Masuk Awal (Simulasi Inisialisasi Stok)
                        await supabaseClient.from('barang_masuk').insert({
                            produk_id: newId, 
                            jumlah_unit_besar: item.initial_stok_dus,
                            tanggal_masuk: new Date().toISOString().split('T')[0], // Format DATE YYYY-MM-DD
                            sumber: 'Stok Awal Sistem',
                            catatan: 'Data inisialisasi awal',
                            user_id: userId,
                        });
                    }
                }
            } catch (error) {
                console.error("Error setting up initial data:", error);
                showToast("Gagal menginisialisasi data awal (Produk/Stok). Cek skema dan RLS.", 'error');
            }
        }
        
        // --- FETCH DATA FROM SUPABASE ---
        
        // FUNGSI BARU: Mengambil Stok langsung dari SQL VIEW
        async function fetchStockView() {
            // Catatan: Karena View tidak mencakup user_id, kita mengambil semua data stok global.
            // Jika Anda ingin memfilter stok per pengguna, View harus dimodifikasi untuk menyertakan user_id
            // atau menggunakan RLS Policy yang sesuai pada tabel dasar.
            const { data, error } = await supabaseClient
                .from('stok_saat_ini_pcs') // Mengambil data dari View
                .select('*'); 
            
            if (error) {
                console.error("Error fetching stock view:", error);
                showToast("Gagal memuat data stok dari View. Pastikan View 'stok_saat_ini_pcs' ada.", 'error');
                return;
            }

            stockData = {};
            let totalStokGlobal = 0;

            data.forEach(item => {
                const stok = Number(item.stok_aktual_unit_kecil);
                stockData[item.produk_id] = stok;
                totalStokGlobal += stok;
            });

            document.getElementById('total-stok-display').textContent = totalStokGlobal.toLocaleString('id-ID');
            console.log("Stok Aktual (dari View) diperbarui:", stockData);
            updateDraftUI(); 
        }

        // Fetch Produk (Data Master)
        async function fetchProducts() {
            const { data, error } = await supabaseClient
                .from('produk')
                .select('*');
            
            if (error) {
                console.error("Error fetching products:", error);
                showToast("Gagal memuat data produk.", 'error');
                return;
            }
            products = data;
            populateProductSelect();
            console.log("Produk diperbarui:", products.length);
        }

        // Fetch Barang Keluar (untuk Display Riwayat)
        async function fetchOutgoing() {
            const { data, error } = await supabaseClient
                .from('barang_keluar')
                .select('*')
                .eq('user_id', userId) // Filter data berdasarkan pengguna
                .order('tanggal_keluar', { ascending: false });
            
            if (error) {
                console.error("Error fetching outgoing:", error);
                showToast("Gagal memuat riwayat barang keluar.", 'error');
                return;
            }
            window.currentOutgoing = data;
            console.log("Transaksi Barang Keluar diperbarui:", data.length);
            renderTransactions(data);
        }
        
        // --- REAL-TIME LISTENERS (Supabase Realtime) ---
        function setupListeners() {
            // Fetch pertama kali
            fetchProducts();
            fetchStockView(); // Panggil View untuk mendapatkan stok
            fetchOutgoing(); // Panggil riwayat keluar

            // Listener untuk Barang Masuk (Perubahan memicu update stok dari View)
            supabaseClient
                .channel('incoming_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'barang_masuk', filter: `user_id=eq.${userId}` }, fetchStockView) 
                .subscribe();

            // Listener untuk Barang Keluar (Perubahan memicu update stok dari View DAN update riwayat)
            supabaseClient
                .channel('outgoing_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'barang_keluar', filter: `user_id=eq.${userId}` }, (payload) => {
                    fetchStockView();
                    fetchOutgoing(); // Re-fetch history
                })
                .subscribe();
        }
        
        // Catatan: Logika 'calculateStock' lama DIBUANG karena digantikan oleh fetchStockView.


        // --- RENDERING FUNCTIONS (TIDAK BERUBAH) ---
        
        function populateProductSelect() {
            const select = document.getElementById('product-select');
            select.innerHTML = '<option value="">Pilih Produk</option>';
            products.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.nama_produk} (${p.unit_besar} = ${p.konversi_kecil} ${p.unit_kecil})`;
                option.setAttribute('data-unit-kecil', p.unit_kecil);
                option.setAttribute('data-konversi', p.konversi_kecil);
                select.appendChild(option);
            });
            select.removeEventListener('change', updateUnitKecilDisplay);
            select.addEventListener('change', updateUnitKecilDisplay);
            select.dispatchEvent(new Event('change')); 
        }

        function updateUnitKecilDisplay() {
            const select = document.getElementById('product-select');
            const jumlahInput = document.getElementById('jumlah-keluar');
            const unitDisplay = document.getElementById('unit-kecil-display');
            const stokWarning = document.getElementById('stok-warning');
            
            const selectedOption = select.options[select.selectedIndex];
            const produkId = selectedOption ? selectedOption.value : null;

            if (produkId) {
                const unitKecil = selectedOption.getAttribute('data-unit-kecil');
                const currentStok = stockData[produkId] || 0;
                
                unitDisplay.textContent = `Unit: ${unitKecil}. Stok tersedia: ${currentStok.toLocaleString('id-ID')} ${unitKecil}`;
                unitDisplay.classList.remove('hidden');

                const checkStock = () => {
                    const jumlah = parseInt(jumlahInput.value) || 0;
                    const addItemBtn = document.getElementById('add-item-btn');
                    
                    if (jumlah <= 0) {
                        stokWarning.textContent = `Jumlah harus lebih dari 0.`;
                        stokWarning.classList.remove('hidden');
                        addItemBtn.disabled = true;
                    } else if (jumlah > currentStok) {
                        stokWarning.textContent = `Stok tidak cukup! Maksimum: ${currentStok.toLocaleString('id-ID')} ${unitKecil}`;
                        stokWarning.classList.remove('hidden');
                        addItemBtn.disabled = true;
                    } else {
                        stokWarning.classList.add('hidden');
                        addItemBtn.disabled = false;
                    }
                };

                jumlahInput.oninput = checkStock; 
                checkStock(); 
            } else {
                unitDisplay.textContent = '';
                unitDisplay.classList.add('hidden');
                stokWarning.classList.add('hidden');
                jumlahInput.oninput = null; 
            }
        }
        
        function renderTransactions(transactions) {
            const listContainer = document.getElementById('transactions-list');
            listContainer.innerHTML = '';

            if (transactions.length === 0) {
                listContainer.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">Belum ada data barang keluar.</td></tr>';
                return;
            }

            transactions.forEach(tx => {
                const product = products.find(p => p.id === tx.produk_id);
                const date = new Date(tx.tanggal_keluar).toLocaleDateString('id-ID'); 

                const row = listContainer.insertRow();
                row.className = "hover:bg-gray-100";

                row.insertCell().textContent = date;
                row.insertCell().textContent = product ? product.nama_produk : 'N/A';
                row.insertCell().textContent = `${Number(tx.jumlah_unit_kecil).toLocaleString('id-ID')} ${product ? product.unit_kecil : ''}`;
                row.insertCell().textContent = tx.tujuan || '-';
                row.insertCell().textContent = tx.catatan || '-';
            });
        }

        function updateDraftUI() {
            const draftListContainer = document.getElementById('draft-list-container');
            const draftCount = document.getElementById('draft-count');
            const saveCount = document.getElementById('save-count');
            const emptyMessage = document.getElementById('empty-draft-message');
            const saveBtn = document.getElementById('save-batch-btn');
            const clearBtn = document.getElementById('clear-draft-btn');
            
            draftListContainer.innerHTML = '';
            
            if (draftTransactions.length === 0) {
                emptyMessage.classList.remove('hidden');
                draftListContainer.appendChild(emptyMessage);
                saveBtn.disabled = true;
                clearBtn.disabled = true;
            } else {
                emptyMessage.classList.add('hidden');
                // Nonaktifkan tombol Save jika ada item yang stoknya kurang
                const hasOverstockedItem = draftTransactions.some(item => item.jumlah_unit_kecil > (stockData[item.produk_id] || 0));
                
                saveBtn.disabled = hasOverstockedItem;
                clearBtn.disabled = false;
                
                draftTransactions.forEach((item, index) => {
                    const product = products.find(p => p.id === item.produk_id);
                    const currentStok = stockData[item.produk_id] || 0;
                    
                    const isOverstocked = item.jumlah_unit_kecil > currentStok;

                    const itemDiv = document.createElement('div');
                    itemDiv.className = `flex justify-between items-center p-3 bg-white rounded-lg shadow-sm ${isOverstocked ? 'border-2 border-red-400' : ''}`;
                    itemDiv.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold truncate">${product ? product.nama_produk : 'N/A'}</p>
                            <p class="text-xs text-gray-600">Jml: ${item.jumlah_unit_kecil.toLocaleString('id-ID')} ${product ? product.unit_kecil : ''} | Tujuan: ${item.tujuan}</p>
                            ${isOverstocked ? '<p class="text-xs text-red-500 font-bold">STOK KURANG (Hapus Item ini)</p>' : ''}
                        </div>
                        <button data-index="${index}" class="remove-draft-btn text-red-500 hover:text-red-700 ml-4 p-1 rounded-full hover:bg-red-100">
                            &times;
                        </button>
                    `;
                    draftListContainer.appendChild(itemDiv);
                });
                
                draftListContainer.querySelectorAll('.remove-draft-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const target = e.target.closest('.remove-draft-btn');
                        if (target) {
                             const index = parseInt(target.getAttribute('data-index'));
                             draftTransactions.splice(index, 1);
                             updateDraftUI();
                        }
                    });
                });
            }
            
            draftCount.textContent = draftTransactions.length;
            saveCount.textContent = draftTransactions.length;
            updateUnitKecilDisplay(); 
        }


        // --- MODAL & BATCH HANDLING (TIDAK BERUBAH) ---

        const modal = document.getElementById('new-transaction-modal');
        document.getElementById('open-modal-btn').addEventListener('click', () => {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            updateDraftUI();
        });
        document.getElementById('close-modal-btn').addEventListener('click', () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });
        
        // Handle Form Tambah Item ke Draft
        document.getElementById('add-item-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const produkId = document.getElementById('product-select').value;
            const jumlah = parseInt(document.getElementById('jumlah-keluar').value);
            const tujuan = document.getElementById('tujuan').value.trim();
            const product = products.find(p => p.id === produkId);

            if (!produkId || jumlah <= 0 || !tujuan || !product) {
                showToast("Data input tidak lengkap atau tidak valid.", 'error');
                return;
            }

            const currentStok = stockData[produkId] || 0;
            if (jumlah > currentStok) {
                 showToast(`Gagal: Stok ${product.nama_produk} tidak cukup. Tersedia: ${currentStok.toLocaleString('id-ID')}`, 'error');
                 return;
            }

            // Tambahkan ke draft state (client-side batch)
            draftTransactions.push({
                produk_id: produkId,
                jumlah_unit_kecil: jumlah,
                tujuan: tujuan,
                tanggal_keluar: new Date().toISOString().split('T')[0], // Format DATE YYYY-MM-DD
                catatan: '', 
                user_id: userId, // Sertakan user_id
            });

            // Reset form dan update UI draft
            document.getElementById('add-item-form').reset();
            document.getElementById('product-select').dispatchEvent(new Event('change')); 
            updateDraftUI();
            showToast(`Item ${product.nama_produk} ditambahkan ke draft.`, 'success');
        });

        // Handle Clear Draft
        document.getElementById('clear-draft-btn').addEventListener('click', () => {
            const confirmAction = window.prompt("Ketik 'YA' untuk menghapus semua draft transaksi:", "");
            if (confirmAction && confirmAction.toUpperCase() === 'YA') {
                draftTransactions = [];
                updateDraftUI();
                showToast("Draft transaksi telah dikosongkan.", 'info');
            } else if (confirmAction !== null) {
                showToast("Penghapusan draft dibatalkan.", 'info');
            }
        });

        // Handle Save Batch (Approve)
        document.getElementById('save-batch-btn').addEventListener('click', async () => {
            if (draftTransactions.length === 0) return;

            const numItems = draftTransactions.length;
            
            // Re-check stok sebelum simpan final (Penting!)
            let itemsToSave = [];
            let tempStockData = { ...stockData }; 
            let hasStockError = false;

            // Memastikan item yang ditambahkan masih memiliki stok saat ini
            draftTransactions.forEach(item => {
                const stock = tempStockData[item.produk_id] || 0;
                if (item.jumlah_unit_kecil > stock) {
                    hasStockError = true;
                } else {
                    tempStockData[item.produk_id] -= item.jumlah_unit_kecil; // Simulasi pengurangan stok
                    itemsToSave.push(item);
                }
            });

            if (hasStockError) {
                showToast("Simpan batch dibatalkan karena ada item yang kekurangan stok saat konfirmasi. Mohon periksa draft Anda.", 'error');
                return;
            }
            
            if (itemsToSave.length === 0) {
                 showToast("Tidak ada item yang valid untuk disimpan.", 'info');
                 return;
            }

            try {
                // Supabase menggunakan 'insert' untuk batch operation
                const { error } = await supabaseClient
                    .from('barang_keluar')
                    .insert(itemsToSave);
                
                if (error) throw error;

                // Bersihkan draft setelah commit sukses
                draftTransactions = [];
                updateDraftUI();
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                showToast(`${itemsToSave.length} transaksi Barang Keluar berhasil disimpan.`, 'success');
                
            } catch (error) {
                console.error("Error committing batch:", error);
                showToast("Gagal menyimpan transaksi batch. Silakan coba lagi.", 'error');
            }
        });


        // --- UTILITY: TOAST NOTIFICATION ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let bgColor = 'bg-blue-500';
            if (type === 'success') bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'info') bgColor = 'bg-gray-500';

            toast.className = `p-3 rounded-lg text-white shadow-xl ${bgColor} flex items-center space-x-2 transition duration-300 transform opacity-0 translate-y-2`;
            toast.textContent = message;

            container.appendChild(toast);
            
            // Animasi masuk
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-y-2');
                toast.classList.add('opacity-100', 'translate-y-0');
            }, 50); 

            // Animasi keluar
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Initialize App
        initializeSupabase();

        // Mobile Sidebar Toggle
        document.getElementById('menu-toggle').addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        });

    </script>
</body>
</html>
