<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InventPro - Dashboard Inventori Multi-Fitur (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .sidebar { width: 280px; transition: transform 0.3s ease-in-out; z-index: 50; }
        .main-content { margin-left: 280px; }
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-280px); position: fixed; height: 100%; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
        }
        .bg-sidebar { background-color: #171c26; }
        .bg-sidebar-active { background-color: #f76807; } /* Warna primer orange */
        .text-sidebar-inactive { color: #b0b4ba; }
        .text-sidebar-active { color: #ffffff; }
        .btn-primary { background-color: #f76807; color: white; }
        .btn-primary:hover { background-color: #e05e00; }
        .btn-secondary { background-color: #4a5568; color: white; }
        .btn-secondary:hover { background-color: #2d3748; }
        /* Modal Backdrop */
        .modal-backdrop { z-index: 99; background-color: rgba(0, 0, 0, 0.5); }
        .modal-content { z-index: 100; }
    </style>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden">

    <button id="menu-toggle" class="lg:hidden fixed top-4 left-4 p-2 rounded-lg bg-white shadow-md z-50">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
    </button>

    <div id="sidebar" class="sidebar bg-sidebar flex flex-col fixed h-full shadow-lg lg:relative lg:translate-x-0">
        <div class="p-6 text-white border-b border-gray-700/50">
            <h1 class="text-2xl font-bold">InventPro</h1>
            <p class="text-sm text-gray-400">Supabase Inventory</p>
        </div>
        <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
            <p class="text-xs font-semibold uppercase text-gray-500/70 px-4 pt-4 pb-2">Menu Utama</p>
            
            <a href="#" data-page="stok-saat-ini" class="menu-link flex items-center space-x-3 p-3 rounded-lg text-sidebar-inactive hover:bg-sidebar-active hover:text-sidebar-active font-semibold active-link">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                <span>Stok Saat Ini</span>
            </a>

            <a href="#" data-page="barang-masuk" class="menu-link flex items-center space-x-3 p-3 rounded-lg text-sidebar-inactive hover:bg-sidebar-active hover:text-sidebar-active font-semibold">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0a9 9 0 01-18 0z"></path></svg>
                <span>Barang Masuk</span>
            </a>

            <a href="#" data-page="barang-keluar" class="menu-link flex items-center space-x-3 p-3 rounded-lg text-sidebar-inactive hover:bg-sidebar-active hover:text-sidebar-active font-semibold">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 9h4.004M11 15h4.004m-4.004-7.004h1.002M11 14.996h1.002M13 12h4.004m-4.004-2.004h1.002M13 15.004h1.002M18 12a6 6 0 00-6-6v6H6a6 6 0 1012 0z"></path></svg>
                <span>Barang Keluar</span>
            </a>
            
            <p class="text-xs font-semibold uppercase text-gray-500/70 px-4 pt-4 pb-2">Pengaturan Data</p>

            <a href="#" data-page="master-produk" class="menu-link flex items-center space-x-3 p-3 rounded-lg text-sidebar-inactive hover:bg-sidebar-active hover:text-sidebar-active font-semibold">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span>Master Produk</span>
            </a>
            
        </nav>
        <div class="p-4 text-xs text-gray-500/70 border-t border-gray-700/50">
            Â© 2024 InventPro v3.0
        </div>
    </div>

    <div class="main-content flex-1 flex flex-col overflow-hidden">
        
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shadow-sm">
            <h2 id="page-title" class="text-xl font-semibold text-gray-800">Stok Saat Ini</h2>
            <div class="flex items-center space-x-4 ml-auto">
                <span id="user-id-display" class="text-xs text-gray-500 truncate"></span>
                <button class="p-2 text-gray-500 hover:text-gray-700 relative">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1"></path></svg>
                </button>
            </div>
        </header>

        <main id="main-content-area" class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-6">
            </main>
    </div>

    <div id="universal-modal" class="modal-backdrop fixed inset-0 hidden items-center justify-center p-4">
        </div>
    
    <div id="toast-container" class="fixed bottom-4 right-4 space-y-2"></div>

    <script type="module">
        // 1. IMPOR SDK SUPABASE
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // 2. KONFIGURASI SUPABASE (GANTI DENGAN KUNCI ANDA)
        const supabaseUrl = 'https://iltqolfmvhzaiuagtoxt.supabase.co'; // GANTI INI
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsdHFvbGZtdmh6YWl1YWd0b3h0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNDE5MjQsImV4cCI6MjA4MDgxNzkyNH0.sGzEQjpKfy7fdw8KBNO7mVzKd2tuxqQaYAdRuTjHVMs'; // GANTI INI
        
        let supabase = null;
        let userId = null;
        let products = [];
        let incomingTransactions = [];
        let outgoingTransactions = [];
        let stockData = {}; // {produk_id: stok_aktual_unit_kecil}
        let draftTransactions = [];
        let currentPage = 'stok-saat-ini';

        // --- SUPABASE INITIALIZATION AND AUTHENTICATION ---
        async function initializeAuthAndSupabase() {
            if (supabaseUrl === 'https://iltqolfmvhzaiuagtoxt.supabase.co') {
                document.getElementById('main-content-area').innerHTML = '<div class="text-red-600 text-center p-10">ERROR: Harap ganti YOUR_SUPABASE_URL dan YOUR_SUPABASE_ANON_KEY dalam kode JavaScript.</div>';
                return;
            }

            // Inisialisasi Supabase Client
            supabase = createClient(supabaseUrl, supabaseAnonKey);

            try {
                // Simulasi Auth Anonim untuk mendapatkan user_id yang persisten
                let { data: authData, error } = await supabase.auth.signInAnonymously();
                
                if (error) throw error;
                
                // Gunakan UUID user Supabase sebagai user_id
                userId = authData.user?.id || crypto.randomUUID(); 

                document.getElementById('user-id-display').textContent = `User ID: ${userId.substring(0, 8)}...`;
                console.log("Supabase Client & Auth initialized for user:", userId);

                await setupData(); // Masukkan data inisial jika belum ada
                setupListeners();
                renderPage(currentPage); 

            } catch (error) {
                console.error("Error during Supabase initialization or sign-in:", error.message);
                showToast(`Gagal memuat aplikasi. Cek koneksi Supabase Anda: ${error.message}`, 'error');
            }
        }

        // --- DATA SETUP (SIMULASI MASTER DATA) ---
        async function setupData() {
            const mockProducts = [
                { id: 'prod-001', nama_produk: 'Air Mineral 600ml', sku: 'AM-600', unit_besar: 'Dus', unit_kecil: 'Botol', konversi_kecil: 24 },
                { id: 'prod-002', nama_produk: 'Soft Drink Kaleng', sku: 'SD-CLG', unit_besar: 'Pack', unit_kecil: 'Kaleng', konversi_kecil: 6 },
                { id: 'prod-003', nama_produk: 'Mie Instan Kuah', sku: 'MI-KUH', unit_besar: 'Karton', unit_kecil: 'Bungkus', konversi_kecil: 40 },
            ];
            
            // 1. Upsert Master Produk
            const { error: productError } = await supabase
                .from('master_produk')
                .upsert(mockProducts, { onConflict: 'id' }); 
            
            if (productError) {
                console.error("Error upserting mock products:", productError);
                return;
            }

            // 2. Cek dan Tambahkan Stok Awal (Barang Masuk)
            const initialIncoming = [
                { produk_id: 'prod-001', jumlah_unit_besar: 50, sumber: 'Stok Awal', catatan: 'Initial seed data', user_id: userId },
                { produk_id: 'prod-002', jumlah_unit_besar: 100, sumber: 'Stok Awal', catatan: 'Initial seed data', user_id: userId },
                { produk_id: 'prod-003', jumlah_unit_besar: 30, sumber: 'Stok Awal', catatan: 'Initial seed data', user_id: userId },
            ];

            // Cek apakah sudah ada data barang masuk untuk user ini (untuk menghindari duplikasi saat refresh)
            const { data: existingIncoming, error: checkError } = await supabase
                .from('barang_masuk')
                .select('id')
                .eq('user_id', userId)
                .limit(1);

            if (checkError) {
                console.error("Error checking existing incoming:", checkError);
                return;
            }

            if (existingIncoming.length === 0) {
                const incomingData = initialIncoming.map(item => ({
                    ...item,
                    tanggal_masuk: new Date().toISOString(),
                }));

                const { error: incomingError } = await supabase
                    .from('barang_masuk')
                    .insert(incomingData);

                if (incomingError) {
                    console.error("Error inserting initial incoming:", incomingError);
                }
            }
        }

        // --- REAL-TIME LISTENERS (SUPABASE) ---
        function setupListeners() {
            // 1. Listener Master Produk
            const productChannel = supabase
                .channel('master_produk_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'master_produk' }, (payload) => {
                    // Cukup panggil fungsi fetch ulang untuk kesederhanaan
                    fetchProducts();
                })
                .subscribe();

            // 2. Listener Barang Masuk (Filter berdasarkan user_id)
            const incomingChannel = supabase
                .channel('barang_masuk_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'barang_masuk', filter: `user_id=eq.${userId}` }, (payload) => {
                    fetchIncomingTransactions();
                })
                .subscribe();

            // 3. Listener Barang Keluar (Filter berdasarkan user_id)
            const outgoingChannel = supabase
                .channel('barang_keluar_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'barang_keluar', filter: `user_id=eq.${userId}` }, (payload) => {
                    fetchOutgoingTransactions();
                })
                .subscribe();

            // Panggil fungsi fetch awal
            fetchProducts();
            fetchIncomingTransactions();
            fetchOutgoingTransactions();
        }

        // --- FETCH FUNCTIONS (Mengambil Data dari Supabase) ---
        async function fetchProducts() {
            const { data, error } = await supabase
                .from('master_produk')
                .select('*')
                .order('nama_produk', { ascending: true });

            if (error) console.error("Error fetching products:", error);
            else products = data;
            
            calculateStock();
            if(currentPage === 'master-produk') renderMasterProdukPage();
        }

        async function fetchIncomingTransactions() {
            const { data, error } = await supabase
                .from('barang_masuk')
                .select('*')
                .eq('user_id', userId)
                .order('tanggal_masuk', { ascending: false });

            if (error) console.error("Error fetching incoming:", error);
            else incomingTransactions = data;
            
            calculateStock();
            if(currentPage === 'barang-masuk') renderBarangMasukPage();
        }

        async function fetchOutgoingTransactions() {
            const { data, error } = await supabase
                .from('barang_keluar')
                .select('*')
                .eq('user_id', userId)
                .order('tanggal_keluar', { ascending: false });

            if (error) console.error("Error fetching outgoing:", error);
            else outgoingTransactions = data;

            calculateStock();
            if(currentPage === 'barang-keluar') renderBarangKeluarPage();
        }

        // --- STOK CALCULATION LOGIC (Tidak Berubah) ---
        function calculateStock() {
            stockData = {};
            products.forEach(p => {
                const konversi = p.konversi_kecil;
                
                // 1. Hitung Total Masuk (dalam unit kecil)
                const totalMasukUnitKecil = incomingTransactions
                    .filter(item => item.produk_id === p.id)
                    .reduce((sum, item) => sum + (Number(item.jumlah_unit_besar) * konversi), 0); 

                // 2. Hitung Total Keluar (sudah dalam unit kecil)
                const totalKeluarUnitKecil = outgoingTransactions
                    .filter(item => item.produk_id === p.id)
                    .reduce((sum, item) => sum + Number(item.jumlah_unit_kecil), 0);

                // 3. Stok Aktual
                const stok = totalMasukUnitKecil - totalKeluarUnitKecil;
                stockData[p.id] = stok;
            });
            
            // Update UI
            if(currentPage === 'stok-saat-ini') renderStokSaatIniPage();
            updateDraftUI(); 
        }

        // --- UTILITY FUNCTIONS ---
        function findProduct(id) {
            return products.find(p => p.id === id);
        }

        function formatDate(timestamp) {
            // Supabase mengembalikan ISO string, perlu dikonversi
            if (timestamp) {
                return new Date(timestamp).toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric' });
            }
            return '-';
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let bgColor = 'bg-blue-500';
            if (type === 'success') bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'info') bgColor = 'bg-gray-500';

            toast.className = `p-3 rounded-lg text-white shadow-xl ${bgColor} flex items-center space-x-2 transition duration-300 transform opacity-0 translate-y-2`;
            toast.textContent = message;

            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-y-2');
                toast.classList.add('opacity-100', 'translate-y-0');
            }, 50); 

            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // --- PAGE RENDERING (SPA LOGIC) (Tidak Berubah) ---
        function renderPage(pageName) {
            currentPage = pageName;
            const contentArea = document.getElementById('main-content-area');
            const pageTitle = document.getElementById('page-title');
            const menuLinks = document.querySelectorAll('.menu-link');

            // 1. Reset Menu Link Active State
            menuLinks.forEach(link => {
                link.classList.remove('bg-sidebar-active', 'text-sidebar-active');
                link.classList.add('text-sidebar-inactive', 'hover:bg-sidebar-active', 'hover:text-sidebar-active');
                if (link.getAttribute('data-page') === pageName) {
                    link.classList.add('bg-sidebar-active', 'text-sidebar-active');
                    link.classList.remove('text-sidebar-inactive');
                }
            });

            // 2. Render Page Content
            contentArea.innerHTML = '';
            
            if (pageName === 'stok-saat-ini') {
                pageTitle.textContent = 'Stok Barang Saat Ini';
                renderStokSaatIniPage();
            } else if (pageName === 'barang-masuk') {
                pageTitle.textContent = 'Pencatatan Barang Masuk';
                renderBarangMasukPage();
            } else if (pageName === 'barang-keluar') {
                pageTitle.textContent = 'Pencatatan Barang Keluar';
                renderBarangKeluarPage();
            } else if (pageName === 'master-produk') {
                pageTitle.textContent = 'Master Data Produk';
                renderMasterProdukPage();
            }

            // 3. Close mobile sidebar
            document.getElementById('sidebar').classList.remove('open');
        }

        // --- PAGE 1: STOK SAAT INI (Tidak Berubah selain pemanggilan fungsi) ---
        function renderStokSaatIniPage() {
            const contentArea = document.getElementById('main-content-area');
            let totalGlobalStok = Object.values(stockData).reduce((sum, stok) => sum + stok, 0);

            let tableRows = '';
            products.forEach(p => {
                const stok = stockData[p.id] || 0;
                const statusColor = stok <= 0 ? 'text-red-500 font-bold' : (stok < (p.konversi_kecil * 5) ? 'text-orange-500' : 'text-green-600');
                
                // Konversi stok unit kecil kembali ke unit besar (jika ada sisa)
                const unitBesar = Math.floor(stok / p.konversi_kecil);
                const sisaKecil = stok % p.konversi_kecil;
                
                let stokDisplay = `${unitBesar} ${p.unit_besar}`;
                if (sisaKecil > 0) {
                    stokDisplay += ` + ${sisaKecil} ${p.unit_kecil}`;
                } else if (stok === 0) {
                    stokDisplay = 'Stok Kosong';
                }

                tableRows += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${p.nama_produk}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.sku}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.unit_besar} = ${p.konversi_kecil} ${p.unit_kecil}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${statusColor}">
                            ${stokDisplay}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stok.toLocaleString('id-ID')} ${p.unit_kecil}</td>
                    </tr>
                `;
            });

            contentArea.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">Ringkasan Stok Aktual</h1>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="bg-white p-5 rounded-xl shadow-lg flex justify-between items-center border-l-4 border-blue-500">
                        <div>
                            <span class="text-sm text-gray-500">Total Stok Global (Unit Kecil)</span>
                            <span class="block text-3xl font-bold text-blue-600">${totalGlobalStok.toLocaleString('id-ID')}</span>
                        </div>
                        <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 14v10"></path></svg>
                    </div>
                </div>

                <div class="bg-white p-4 sm:p-8 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">Detail Stok per Produk</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produk</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Konversi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stok (Unit Besar & Sisa)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stok Total (Unit Kecil)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows || '<tr><td colspan="5" class="py-4 text-center text-gray-500">Tidak ada data produk.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // --- PAGE 2: BARANG MASUK (Tidak Berubah selain pemanggilan fungsi) ---
        function renderBarangMasukPage() {
            const contentArea = document.getElementById('main-content-area');

            let tableRows = '';
            incomingTransactions.forEach(tx => {
                const product = findProduct(tx.produk_id);
                const konversi = product ? product.konversi_kecil : 0;
                const totalUnitKecil = Number(tx.jumlah_unit_besar) * konversi;

                tableRows += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${formatDate(tx.tanggal_masuk)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${product ? product.nama_produk : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 font-semibold">${Number(tx.jumlah_unit_besar).toLocaleString('id-ID')} ${product ? product.unit_besar : ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${totalUnitKecil.toLocaleString('id-ID')} ${product ? product.unit_kecil : ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.sumber || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.catatan || '-'}</td>
                    </tr>
                `;
            });


            contentArea.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <h1 class="text-2xl font-bold text-gray-800 flex items-center space-x-2 mb-4 sm:mb-0">
                        <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(-90deg);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                        <span>Riwayat Barang Masuk</span>
                    </h1>
                    
                    <button id="open-modal-masuk-btn" class="btn-primary flex items-center space-x-2 px-4 py-2 rounded-lg font-semibold shadow-md hover:shadow-lg transition duration-200 w-full sm:w-auto">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        <span>Catat Barang Masuk</span>
                    </button>
                </div>

                <div class="bg-white p-4 sm:p-8 rounded-xl shadow-md mt-6">
                    <h3 class="text-xl font-semibold mb-4">Daftar Barang Masuk (Unit Besar)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Masuk</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produk</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah (Unit Besar)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total (Unit Kecil)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sumber</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catatan</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows || '<tr><td colspan="6" class="py-4 text-center text-gray-500">Belum ada data barang masuk.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('open-modal-masuk-btn').addEventListener('click', openBarangMasukModal);
        }

        // --- PAGE 3: BARANG KELUAR (Tidak Berubah selain pemanggilan fungsi) ---
        function renderBarangKeluarPage() {
            const contentArea = document.getElementById('main-content-area');

            let tableRows = '';
            outgoingTransactions.forEach(tx => {
                const product = findProduct(tx.produk_id);
                const konversi = product ? product.konversi_kecil : 1;
                
                // Konversi unit kecil ke unit besar dan sisa
                const unitBesar = Math.floor(Number(tx.jumlah_unit_kecil) / konversi);
                const sisaKecil = Number(tx.jumlah_unit_kecil) % konversi;

                let jumlahDisplay = `${Number(tx.jumlah_unit_kecil).toLocaleString('id-ID')} ${product ? product.unit_kecil : ''}`;
                if (unitBesar > 0) {
                    jumlahDisplay += ` (${unitBesar} ${product.unit_besar} ${sisaKecil > 0 ? `+ ${sisaKecil} ${product.unit_kecil}` : ''})`;
                }

                tableRows += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${formatDate(tx.tanggal_keluar)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${product ? product.nama_produk : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 font-semibold">${jumlahDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.tujuan || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.catatan || '-'}</td>
                    </tr>
                `;
            });

            contentArea.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <h1 class="text-2xl font-bold text-gray-800 flex items-center space-x-2 mb-4 sm:mb-0">
                        <svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(90deg);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                        <span>Riwayat Barang Keluar</span>
                    </h1>
                    
                    <button id="open-modal-keluar-btn" class="btn-primary flex items-center space-x-2 px-4 py-2 rounded-lg font-semibold shadow-md hover:shadow-lg transition duration-200 w-full sm:w-auto">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        <span>Catat Barang Keluar (Batch)</span>
                    </button>
                </div>

                <div class="bg-white p-4 sm:p-8 rounded-xl shadow-md mt-6">
                    <h3 class="text-xl font-semibold mb-4">Daftar Barang Keluar (Unit Kecil)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produk</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah (Unit Kecil)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tujuan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catatan</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-list-keluar" class="bg-white divide-y divide-gray-200">
                                ${tableRows || '<tr><td colspan="5" class="py-4 text-center text-gray-500">Belum ada data barang keluar.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('open-modal-keluar-btn').addEventListener('click', openBarangKeluarModal);
        }

        // --- PAGE 4: MASTER PRODUK (Tidak Berubah selain pemanggilan fungsi) ---
        function renderMasterProdukPage() {
            const contentArea = document.getElementById('main-content-area');

            let tableRows = '';
            products.forEach(p => {
                tableRows += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.nama_produk}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.sku}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.unit_besar}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.unit_kecil}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.konversi_kecil}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${p.id}" class="edit-product-btn text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                            <button data-id="${p.id}" class="delete-product-btn text-red-600 hover:text-red-900">Hapus</button>
                        </td>
                    </tr>
                `;
            });

            contentArea.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <h1 class="text-2xl font-bold text-gray-800 flex items-center space-x-2 mb-4 sm:mb-0">
                        <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                        <span>Master Data Produk</span>
                    </h1>
                    
                    <button id="open-modal-produk-btn" class="btn-primary flex items-center space-x-2 px-4 py-2 rounded-lg font-semibold shadow-md hover:shadow-lg transition duration-200 w-full sm:w-auto">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        <span>Tambah Produk Baru</span>
                    </button>
                </div>

                <div class="bg-white p-4 sm:p-8 rounded-xl shadow-md mt-6">
                    <h3 class="text-xl font-semibold mb-4">Daftar Produk Aktif</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Produk</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Besar</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Kecil</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Konversi</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows || '<tr><td colspan="6" class="py-4 text-center text-gray-500">Tidak ada data produk.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('open-modal-produk-btn').addEventListener('click', () => openMasterProdukModal());
            document.querySelectorAll('.edit-product-btn').forEach(btn => {
                btn.addEventListener('click', (e) => openMasterProdukModal(e.target.dataset.id));
            });
            document.querySelectorAll('.delete-product-btn').forEach(btn => {
                btn.addEventListener('click', (e) => deleteProduct(e.target.dataset.id));
            });
        }

        // --- MASTER PRODUK CRUD LOGIC (MODAL) (Diubah untuk Supabase) ---
        function openMasterProdukModal(productId = null) {
            // ... (Kode untuk menampilkan modal sama) ...
            const isEdit = productId !== null;
            const product = isEdit ? findProduct(productId) : {};
            const modal = document.getElementById('universal-modal');
            
            modal.innerHTML = `
                <div class="modal-content bg-white w-full max-w-lg rounded-xl shadow-2xl p-6">
                    <div class="flex justify-between items-center border-b pb-3 mb-4">
                        <h3 class="text-2xl font-bold text-gray-800">${isEdit ? 'Edit Produk' : 'Tambah Produk Baru'}</h3>
                        <button class="close-modal-btn text-gray-400 hover:text-gray-600">&times;</button>
                    </div>
                    
                    <form id="product-form" class="space-y-4">
                        <div>
                            <label for="nama_produk" class="block text-sm font-medium text-gray-700">Nama Produk</label>
                            <input type="text" id="nama_produk" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required value="${product.nama_produk || ''}">
                        </div>
                        <div>
                            <label for="sku" class="block text-sm font-medium text-gray-700">SKU (Stock Keeping Unit)</label>
                            <input type="text" id="sku" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required value="${product.sku || ''}">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="unit_besar" class="block text-sm font-medium text-gray-700">Unit Besar (Cth: Dus, Karton)</label>
                                <input type="text" id="unit_besar" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required value="${product.unit_besar || ''}">
                            </div>
                            <div>
                                <label for="unit_kecil" class="block text-sm font-medium text-gray-700">Unit Kecil (Cth: Botol, Bungkus)</label>
                                <input type="text" id="unit_kecil" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required value="${product.unit_kecil || ''}">
                            </div>
                        </div>
                        <div>
                            <label for="konversi_kecil" class="block text-sm font-medium text-gray-700">Jumlah Unit Kecil dalam 1 Unit Besar</label>
                            <input type="number" id="konversi_kecil" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="1" required value="${product.konversi_kecil || ''}">
                        </div>
                        <button type="submit" class="w-full btn-primary px-4 py-2 rounded-lg font-semibold transition duration-200">
                            ${isEdit ? 'Simpan Perubahan' : 'Tambah Produk'}
                        </button>
                    </form>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            modal.querySelector('.close-modal-btn').addEventListener('click', () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            });

            document.getElementById('product-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newProductData = {
                    nama_produk: document.getElementById('nama_produk').value.trim(),
                    sku: document.getElementById('sku').value.trim(),
                    unit_besar: document.getElementById('unit_besar').value.trim(),
                    unit_kecil: document.getElementById('unit_kecil').value.trim(),
                    konversi_kecil: parseInt(document.getElementById('konversi_kecil').value),
                };

                try {
                    if (isEdit) {
                        // UPDATE data di Supabase
                        const { error } = await supabase
                            .from('master_produk')
                            .update(newProductData)
                            .eq('id', productId);

                        if (error) throw error;
                        showToast(`Produk ${newProductData.nama_produk} berhasil diperbarui.`, 'success');
                    } else {
                        // INSERT data baru di Supabase
                        const { error } = await supabase
                            .from('master_produk')
                            .insert({ ...newProductData, id: crypto.randomUUID() }); // Supabase akan generate UUID, tapi kita bisa berikan id manual juga

                        if (error) throw error;
                        showToast(`Produk ${newProductData.nama_produk} berhasil ditambahkan.`, 'success');
                    }
                    
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');

                } catch (error) {
                    console.error("Error saving product:", error);
                    showToast(`Gagal menyimpan produk: ${error.message}`, 'error');
                }
            });
        }

        async function deleteProduct(productId) {
            const product = findProduct(productId);
            if (!product) return;

            const confirmAction = window.prompt(`Ketik 'HAPUS ${product.nama_produk}' untuk mengkonfirmasi penghapusan produk ini:`, "");
            if (confirmAction && confirmAction.toUpperCase() === `HAPUS ${product.nama_produk.toUpperCase()}`) {
                try {
                    // DELETE data di Supabase
                    const { error } = await supabase
                        .from('master_produk')
                        .delete()
                        .eq('id', productId);
                        
                    if (error) throw error;

                    showToast(`Produk ${product.nama_produk} berhasil dihapus.`, 'success');
                } catch (error) {
                    console.error("Error deleting product:", error);
                    showToast(`Gagal menghapus produk: ${error.message}`, 'error');
                }
            } else if (confirmAction !== null) {
                showToast("Penghapusan produk dibatalkan.", 'info');
            }
        }


        // --- BARANG MASUK LOGIC (MODAL) (Diubah untuk Supabase) ---
        function openBarangMasukModal() {
            // ... (Kode untuk menampilkan modal sama) ...
            const modal = document.getElementById('universal-modal');
            
            // Buat opsi produk untuk select
            const productOptions = products.map(p => 
                `<option value="${p.id}" data-unit-besar="${p.unit_besar}" data-konversi="${p.konversi_kecil}">${p.nama_produk} (${p.unit_besar})</option>`
            ).join('');

            modal.innerHTML = `
                <div class="modal-content bg-white w-full max-w-lg rounded-xl shadow-2xl p-6">
                    <div class="flex justify-between items-center border-b pb-3 mb-4">
                        <h3 class="text-2xl font-bold text-gray-800">Catat Barang Masuk</h3>
                        <button class="close-modal-btn text-gray-400 hover:text-gray-600">&times;</button>
                    </div>
                    
                    <form id="incoming-form" class="space-y-4">
                        <div>
                            <label for="product-select-masuk" class="block text-sm font-medium text-gray-700">Produk</label>
                            <select id="product-select-masuk" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                                <option value="">Pilih Produk</option>
                                ${productOptions}
                            </select>
                        </div>
                        <div>
                            <label for="jumlah-masuk" class="block text-sm font-medium text-gray-700">Jumlah Masuk</label>
                            <input type="number" id="jumlah-masuk" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="1" required>
                            <p id="unit-besar-display" class="mt-1 text-xs text-gray-500"></p>
                        </div>
                        <div>
                            <label for="sumber-masuk" class="block text-sm font-medium text-gray-700">Sumber (Cth: Supplier A)</label>
                            <input type="text" id="sumber-masuk" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required placeholder="Cth: Supplier A / Produksi">
                        </div>
                        <div>
                            <label for="catatan-masuk" class="block text-sm font-medium text-gray-700">Catatan (Opsional)</label>
                            <textarea id="catatan-masuk" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></textarea>
                        </div>
                        <button type="submit" class="w-full btn-primary px-4 py-2 rounded-lg font-semibold transition duration-200">
                            Simpan Barang Masuk
                        </button>
                    </form>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            modal.querySelector('.close-modal-btn').addEventListener('click', () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            });
            
            const productSelect = document.getElementById('product-select-masuk');
            const unitDisplay = document.getElementById('unit-besar-display');
            productSelect.addEventListener('change', () => {
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                if (selectedOption && selectedOption.value) {
                    const unitBesar = selectedOption.getAttribute('data-unit-besar');
                    unitDisplay.textContent = `Unit yang dicatat adalah Unit Besar: ${unitBesar}`;
                } else {
                    unitDisplay.textContent = '';
                }
            });
            productSelect.dispatchEvent(new Event('change'));


            document.getElementById('incoming-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const produkId = productSelect.value;
                const jumlah = parseInt(document.getElementById('jumlah-masuk').value);
                const sumber = document.getElementById('sumber-masuk').value.trim();
                const catatan = document.getElementById('catatan-masuk').value.trim();
                const product = findProduct(produkId);

                if (!produkId || jumlah <= 0 || !sumber || !product) {
                    showToast("Data input tidak lengkap atau tidak valid.", 'error');
                    return;
                }

                const transactionData = {
                    produk_id: produkId,
                    jumlah_unit_besar: jumlah,
                    tanggal_masuk: new Date().toISOString(), // Supabase Timestamp
                    sumber: sumber,
                    catatan: catatan,
                    user_id: userId, // Sertakan user_id
                };

                try {
                    // INSERT data di Supabase
                    const { error } = await supabase
                        .from('barang_masuk')
                        .insert(transactionData);

                    if (error) throw error;
                    
                    showToast(`${jumlah.toLocaleString('id-ID')} ${product.unit_besar} ${product.nama_produk} berhasil dicatat masuk.`, 'success');
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                } catch (error) {
                    console.error("Error saving incoming transaction:", error);
                    showToast(`Gagal menyimpan transaksi masuk: ${error.message}`, 'error');
                }
            });
        }


        // --- BARANG KELUAR LOGIC (MODAL) (Diubah untuk Supabase) ---
        // (openBarangKeluarModal, updateUnitKecilDisplayKeluar, updateDraftUI, handleAddItemToDraft, handleClearDraft - TIDAK BERUBAH)
        function openBarangKeluarModal() {
            const modal = document.getElementById('universal-modal');
            
            // Inject konten modal barang keluar
            modal.innerHTML = `
                <div id="barang-keluar-modal-content" class="modal-content bg-white w-full max-w-4xl rounded-xl shadow-2xl p-6">
                    <div class="flex justify-between items-center border-b pb-3 mb-4">
                        <h3 class="text-2xl font-bold text-gray-800">Catat Barang Keluar (Batch)</h3>
                        <button id="close-modal-keluar-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 border-r lg:pr-6">
                            <h4 class="text-lg font-semibold mb-3 text-gray-700">Tambah Item ke Draft</h4>
                            <form id="add-item-form-keluar" class="space-y-4">
                                <div>
                                    <label for="product-select-keluar" class="block text-sm font-medium text-gray-700">Produk</label>
                                    <select id="product-select-keluar" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                                        <option value="">Pilih Produk</option>
                                        ${products.map(p => 
                                            `<option value="${p.id}" data-unit-kecil="${p.unit_kecil}" data-konversi="${p.konversi_kecil}">${p.nama_produk} (${p.unit_kecil})</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label for="jumlah-keluar" class="block text-sm font-medium text-gray-700">Jumlah Keluar (Unit Kecil)</label>
                                    <input type="number" id="jumlah-keluar" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="1" required>
                                    <p id="unit-kecil-display" class="mt-1 text-xs text-gray-500"></p>
                                    <p id="stok-warning" class="mt-1 text-xs text-red-500 hidden font-semibold">Stok tidak cukup!</p>
                                </div>
                                <div>
                                    <label for="tujuan-keluar" class="block text-sm font-medium text-gray-700">Tujuan/Pelanggan</label>
                                    <input type="text" id="tujuan-keluar" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="Cth: Penjualan Toko A" required>
                                </div>
                                <button type="submit" class="w-full btn-primary px-4 py-2 rounded-lg font-semibold transition duration-200" id="add-item-btn">Tambahkan ke Draft</button>
                            </form>
                        </div>

                        <div class="lg:col-span-2">
                            <h4 class="text-lg font-semibold mb-3 text-gray-700">Draft Transaksi (<span id="draft-count">0</span> Item)</h4>
                            
                            <div id="draft-list-container" class="space-y-3 max-h-80 overflow-y-auto p-2 border rounded-md bg-gray-50 mb-4">
                                <p id="empty-draft-message" class="text-center text-gray-500 py-4">Draft kosong. Tambahkan item di samping.</p>
                                </div>

                            <div class="flex justify-between items-center pt-4 border-t">
                                <button id="clear-draft-btn" class="text-red-500 hover:text-red-700 text-sm disabled:opacity-50" disabled>Hapus Draft</button>
                                <button id="save-batch-btn" class="btn-primary px-6 py-3 rounded-lg font-bold disabled:opacity-50" disabled>
                                    Simpan & Approve (<span id="save-count">0</span>)
                                </button>
                            </div>
                        </div>
                    </div>
                    
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Attach event listeners for Barang Keluar Modal
            document.getElementById('close-modal-keluar-btn').addEventListener('click', () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            });
            document.getElementById('product-select-keluar').addEventListener('change', updateUnitKecilDisplayKeluar);
            document.getElementById('add-item-form-keluar').addEventListener('submit', handleAddItemToDraft);
            document.getElementById('clear-draft-btn').addEventListener('click', handleClearDraft);
            document.getElementById('save-batch-btn').addEventListener('click', handleSaveBatch);
            
            updateDraftUI(); // Tampilkan draft yang mungkin sudah ada
        }
        
        function updateUnitKecilDisplayKeluar() {
            const select = document.getElementById('product-select-keluar');
            const jumlahInput = document.getElementById('jumlah-keluar');
            const unitDisplay = document.getElementById('unit-kecil-display');
            const stokWarning = document.getElementById('stok-warning');
            
            const selectedOption = select.options[select.selectedIndex];
            const produkId = selectedOption ? selectedOption.value : null;

            if (produkId) {
                const unitKecil = selectedOption.getAttribute('data-unit-kecil');
                const currentStok = stockData[produkId] || 0;
                
                unitDisplay.textContent = `Unit: ${unitKecil}. Stok tersedia: ${currentStok.toLocaleString('id-ID')} ${unitKecil}`;
                unitDisplay.classList.remove('hidden');

                const checkStock = () => {
                    const jumlah = parseInt(jumlahInput.value) || 0;
                    const addItemBtn = document.getElementById('add-item-btn');
                    
                    if (jumlah <= 0) {
                        stokWarning.textContent = `Jumlah harus lebih dari 0.`;
                        stokWarning.classList.remove('hidden');
                        addItemBtn.disabled = true;
                    } else if (jumlah > currentStok) {
                        stokWarning.textContent = `Stok tidak cukup! Maksimum: ${currentStok.toLocaleString('id-ID')} ${unitKecil}`;
                        stokWarning.classList.remove('hidden');
                        addItemBtn.disabled = true;
                    } else {
                        stokWarning.classList.add('hidden');
                        addItemBtn.disabled = false;
                    }
                };

                jumlahInput.oninput = checkStock; 
                checkStock(); 
            } else {
                unitDisplay.textContent = '';
                unitDisplay.classList.add('hidden');
                stokWarning.classList.add('hidden');
                jumlahInput.oninput = null; 
            }
        }
        
        function updateDraftUI() {
            const draftListContainer = document.getElementById('draft-list-container');
            if (!draftListContainer) return; 
            
            const draftCount = document.getElementById('draft-count');
            const saveCount = document.getElementById('save-count');
            const emptyMessage = document.getElementById('empty-draft-message');
            const saveBtn = document.getElementById('save-batch-btn');
            const clearBtn = document.getElementById('clear-draft-btn');
            
            draftListContainer.innerHTML = '';
            
            if (draftTransactions.length === 0) {
                emptyMessage.classList.remove('hidden');
                draftListContainer.appendChild(emptyMessage);
                saveBtn.disabled = true;
                clearBtn.disabled = true;
            } else {
                emptyMessage.classList.add('hidden');
                saveBtn.disabled = false;
                clearBtn.disabled = false;
                
                draftTransactions.forEach((item, index) => {
                    const product = findProduct(item.produk_id);
                    const currentStok = stockData[item.produk_id] || 0;
                    const isOverstocked = item.jumlah_unit_kecil > currentStok;

                    const itemDiv = document.createElement('div');
                    itemDiv.className = `flex justify-between items-center p-3 bg-white rounded-lg shadow-sm ${isOverstocked ? 'border-2 border-red-400' : 'border border-gray-100'}`;
                    itemDiv.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold truncate">${product ? product.nama_produk : 'N/A'}</p>
                            <p class="text-xs text-gray-600">Jml: ${item.jumlah_unit_kecil.toLocaleString('id-ID')} ${product ? product.unit_kecil : ''} | Tujuan: ${item.tujuan}</p>
                            ${isOverstocked ? '<p class="text-xs text-red-500 font-bold">STOK KURANG! (Hapus Item ini)</p>' : ''}
                        </div>
                        <button data-index="${index}" class="remove-draft-btn text-red-500 hover:text-red-700 ml-4 p-1 rounded-full hover:bg-red-100">
                            &times;
                        </button>
                    `;
                    draftListContainer.appendChild(itemDiv);
                });
                
                draftListContainer.querySelectorAll('.remove-draft-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const target = e.target.closest('[data-index]');
                        if (target) {
                            const index = parseInt(target.getAttribute('data-index'));
                            draftTransactions.splice(index, 1);
                            updateDraftUI();
                        }
                    });
                });
            }
            
            draftCount.textContent = draftTransactions.length;
            saveCount.textContent = draftTransactions.length;
            updateUnitKecilDisplayKeluar(); 
        }

        function handleAddItemToDraft(e) {
            e.preventDefault();
            const produkId = document.getElementById('product-select-keluar').value;
            const jumlah = parseInt(document.getElementById('jumlah-keluar').value);
            const tujuan = document.getElementById('tujuan-keluar').value.trim();
            const product = findProduct(produkId);

            if (!produkId || jumlah <= 0 || !tujuan || !product) {
                showToast("Data input tidak lengkap atau tidak valid.", 'error');
                return;
            }

            const currentStok = stockData[produkId] || 0;
            if (jumlah > currentStok) {
                 showToast(`Gagal: Stok ${product.nama_produk} tidak cukup. Tersedia: ${currentStok.toLocaleString('id-ID')}`, 'error');
                 return;
            }

            draftTransactions.push({
                produk_id: produkId,
                jumlah_unit_kecil: jumlah,
                tujuan: tujuan,
                tanggal_keluar: new Date().toISOString(), // Supabase Timestamp
                catatan: '', 
                user_id: userId,
            });

            document.getElementById('add-item-form-keluar').reset();
            document.getElementById('product-select-keluar').dispatchEvent(new Event('change')); 
            updateDraftUI();
            showToast(`Item ${product.nama_produk} ditambahkan ke draft.`, 'success');
        }

        function handleClearDraft() {
            const confirmAction = window.prompt("Ketik 'YA' untuk menghapus semua draft transaksi:", "");
            if (confirmAction && confirmAction.toUpperCase() === 'YA') {
                draftTransactions = [];
                updateDraftUI();
                showToast("Draft transaksi telah dikosongkan.", 'info');
            } else if (confirmAction !== null) {
                showToast("Penghapusan draft dibatalkan.", 'info');
            }
        }

        // --- BARANG KELUAR SAVE BATCH (Diubah untuk Supabase) ---
        async function handleSaveBatch() {
            if (draftTransactions.length === 0) return;

            let itemsToCommit = [];

            draftTransactions.forEach(item => {
                const stock = stockData[item.produk_id] || 0;
                const product = findProduct(item.produk_id);

                if (item.jumlah_unit_kecil > stock) {
                    showToast(`Error Batch: Stok ${product.nama_produk} tidak cukup. Item ini **dibatalkan** dari batch.`, 'error');
                } else {
                    itemsToCommit.push(item);
                }
            });

            if (itemsToCommit.length === 0) {
                 showToast("Semua item dalam draft dibatalkan karena masalah stok. Mohon periksa draft Anda.", 'error');
                 draftTransactions = [];
                 updateDraftUI();
                 return;
            }

            try {
                // Supabase menggunakan .insert([]) untuk batch insert
                const { error } = await supabase
                    .from('barang_keluar')
                    .insert(itemsToCommit);

                if (error) throw error;

                // Bersihkan draft
                draftTransactions = [];
                updateDraftUI();

                document.getElementById('universal-modal').classList.add('hidden');
                document.getElementById('universal-modal').classList.remove('flex');
                showToast(`${itemsToCommit.length} transaksi Barang Keluar berhasil disimpan.`, 'success');
                
            } catch (error) {
                console.error("Error committing batch:", error);
                showToast(`Gagal menyimpan transaksi batch: ${error.message}`, 'error');
            }
        }

        // --- GLOBAL EVENT LISTENERS (Tidak Berubah) ---
        document.querySelectorAll('.menu-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.getAttribute('data-page');
                renderPage(page);
            });
        });

        document.getElementById('menu-toggle').addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        });

        // Initialize App
        initializeAuthAndSupabase();
    </script>
</body>
</html>
