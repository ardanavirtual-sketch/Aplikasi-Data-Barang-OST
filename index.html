<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InventPro - Dashboard Inventori Supabase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Gaya Tailwind Custom */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .sidebar { width: 280px; transition: transform 0.3s ease-in-out; z-index: 50; }
        .main-content { margin-left: 280px; }
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-280px); position: fixed; height: 100%; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
        }
        .bg-sidebar { background-color: #171c26; }
        .bg-sidebar-active { background-color: #272d3a; }
        .text-sidebar-inactive { color: #b0b4ba; }
        .text-sidebar-active { color: #ffffff; }
        .nav-link.active { background-color: #f76807; color: white; } /* Warna Oranye untuk aktif */
        .nav-link:hover:not(.active) { background-color: #272d3a; color: #ffffff; }

        .btn-primary { background-color: #f76807; color: white; hover:bg-orange-700; }
        .btn-success { background-color: #10b981; color: white; hover:bg-green-700; }
        .btn-danger { background-color: #ef4444; color: white; hover:bg-red-700; }
        
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
    </style>
    
    <script type="module">
        const { createClient } = supabase;

        // --- SUPABASE INITIALIZATION ---
        // PENTING: Ganti placeholder ini dengan kredensial Supabase Anda.
        // Kegagalan untuk mengganti ini akan menyebabkan TypeError: Failed to fetch.
        const SUPABASE_URL = 'https://iltqolfmvhzaiuagtoxt.supabase.co'; // GANTI DENGAN URL SUPABASE ANDA
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsdHFvbGZtdmh6YWl1YWd0b3h0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNDE5MjQsImV4cCI6MjA4MDgxNzkyNH0.sGzEQjpKfy7fdw8KBNO7mVzKd2tuxqQaYAdRuTjHVMs'; // GANTI DENGAN ANON KEY SUPABASE ANDA

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let userId = 'demo-user'; // ID Pengguna Sederhana untuk Supabase

        // State Global Aplikasi
        window.appState = {
            products: [],
            stockData: {}, // {produkId: {stok_kecil: 0, konversi: 0, unit_kecil: ''}}
            historyOutgoing: [],
            historyIncoming: [],
            draftTransactions: [],
            currentPage: window.location.hash.substring(1) || 'stock',
            isDataReady: false,
        };
        
        // --- DATA FETCHING ---
        async function fetchProducts() {
            try {
                const { data, error } = await supabase
                    .from('products')
                    .select('*');
                if (error) throw error;
                window.appState.products = data || [];
            } catch (error) {
                console.error("Error fetching products:", error);
                showToast("Gagal memuat data produk.", 'error');
            }
        }

        async function fetchIncoming() {
            try {
                const { data, error } = await supabase
                    .from('incoming')
                    .select('*');
                if (error) throw error;
                window.appState.historyIncoming = data || [];
            } catch (error) {
                console.error("Error fetching incoming:", error);
                showToast("Gagal memuat riwayat masuk.", 'error');
            }
        }

        async function fetchOutgoing() {
            try {
                const { data, error } = await supabase
                    .from('outgoing')
                    .select('*');
                if (error) throw error;
                window.appState.historyOutgoing = data || [];
            } catch (error) {
                console.error("Error fetching outgoing:", error);
                showToast("Gagal memuat riwayat keluar.", 'error');
            }
        }
        
        // --- INITIAL DATA SETUP ---
        async function setupData() {
            // Lakukan pengecekan dan isi data awal jika tabel produk kosong
            try {
                const { data: products, error } = await supabase
                    .from('products')
                    .select('id');
                
                if (error) throw error;

                if (products.length === 0) {
                    const mockProducts = [
                        { nama_produk: 'Air Mineral 600ml', sku: 'AM-600', unit_besar: 'Dus', unit_kecil: 'Botol', konversi_kecil: 24 },
                        { nama_produk: 'Soft Drink Kaleng', sku: 'SD-CLG', unit_besar: 'Pack', unit_kecil: 'Kaleng', konversi_kecil: 6 },
                        { nama_produk: 'Mie Instan Kuah', sku: 'MI-KUH', unit_besar: 'Karton', unit_kecil: 'Bungkus', konversi_kecil: 40 },
                    ];
                    
                    showToast("Mengisi data produk awal. Mohon tunggu sebentar...", 'info');

                    const { error: insertError } = await supabase
                        .from('products')
                        .insert(mockProducts);

                    if (insertError) throw insertError;
                }
            } catch (error) {
                console.error("Error setting up initial data:", error);
                showToast(`Gagal menyiapkan data awal: ${error.message}. Pastikan Kredensial Supabase Anda benar.`, 'error');
            }
        }

        async function loadAllData() {
            if (SUPABASE_URL === 'https://iltqolfmvhzaiuagtoxt.supabase.co' || SUPABASE_ANON_KEY === 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsdHFvbGZtdmh6YWl1YWd0b3h0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNDE5MjQsImV4cCI6MjA4MDgxNzkyNH0.sGzEQjpKfy7fdw8KBNO7mVzKd2tuxqQaYAdRuTjHVMs') {
                showToast("PERINGATAN: Kredensial Supabase belum diatur. Gunakan placeholder.", 'error');
                // Tidak menjalankan fetch jika kredensial placeholder, tapi merender UI kosong
                window.appState.isDataReady = true;
                handleNavigation(); 
                return;
            }
            
            await setupData(); // Pastikan ada data master
            
            // Ambil semua data secara paralel
            await Promise.all([
                fetchProducts(),
                fetchIncoming(),
                fetchOutgoing()
            ]);
            
            updateStockSummary();
            window.appState.isDataReady = true;
            handleNavigation();
        }

        // --- STOCK CALCULATION LOGIC ---
        function updateStockSummary() {
            // ... (Logika perhitungan stok tetap sama seperti sebelumnya, karena hanya bergantung pada data di appState)
            const { products, historyIncoming, historyOutgoing } = window.appState;
            const newStockData = {};

            // Inisialisasi stok
            products.forEach(p => {
                newStockData[p.id] = {
                    stok_kecil: 0,
                    total_masuk_kecil: 0,
                    total_keluar_kecil: 0,
                    konversi: p.konversi_kecil,
                    unit_kecil: p.unit_kecil,
                };
            });

            // Hitung Barang Masuk (dalam unit kecil)
            historyIncoming.forEach(tx => {
                const stockItem = newStockData[tx.produk_id];
                const product = products.find(p => p.id === tx.produk_id);
                if (stockItem && product) {
                    const masukKecil = tx.jumlah_unit_besar * product.konversi_kecil; // Menggunakan konversi dari produk
                    stockItem.stok_kecil += masukKecil;
                    stockItem.total_masuk_kecil += masukKecil;
                }
            });

            // Hitung Barang Keluar (dalam unit kecil)
            historyOutgoing.forEach(tx => {
                const stockItem = newStockData[tx.produk_id];
                if (stockItem) {
                    stockItem.stok_kecil -= tx.jumlah_unit_kecil;
                    stockItem.total_keluar_kecil += tx.jumlah_unit_kecil;
                }
            });

            window.appState.stockData = newStockData;
            if (['stock', 'master', 'incoming', 'outgoing'].includes(window.appState.currentPage)) renderApp();
        }

        // --- NAVIGATION & ROUTING ---
        function handleNavigation() {
            // ... (Fungsi navigasi tetap sama)
            const newPage = window.location.hash.substring(1) || 'stock';
            if (newPage !== window.appState.currentPage) {
                window.appState.currentPage = newPage;
            }
            // Update sidebar active state
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-page') === window.appState.currentPage) {
                    link.classList.add('active');
                }
            });
            renderApp();
        }
        
        function renderApp() {
            const contentArea = document.getElementById('app-content');
            const { products, stockData, historyOutgoing, historyIncoming, currentPage } = window.appState;

            let htmlContent = '';
            let title = '';

            // Loading state check
            if (!window.appState.isDataReady) {
                 contentArea.innerHTML = renderLoadingState();
                 return;
            }

            switch (currentPage) {
                case 'stock':
                    title = 'Stok Barang Saat Ini';
                    htmlContent = renderStockView(products, stockData);
                    break;
                case 'master':
                    title = 'Master Data Produk';
                    htmlContent = renderMasterDataView(products, stockData);
                    break;
                case 'incoming':
                    title = 'Pencatatan Barang Masuk';
                    htmlContent = renderIncomingView(products, historyIncoming);
                    break;
                case 'outgoing':
                    title = 'Pencatatan Barang Keluar';
                    htmlContent = renderOutgoingView(products, historyOutgoing);
                    break;
                default:
                    title = 'Stok Barang Saat Ini';
                    htmlContent = renderStockView(products, stockData);
                    window.appState.currentPage = 'stock';
                    window.location.hash = '#stock';
            }

            document.getElementById('page-title').textContent = title;
            contentArea.innerHTML = htmlContent;
            
            // Attach event listeners after content injection
            attachDynamicListeners();
        }
        
        function renderLoadingState() {
            return `
                <div class="text-center py-20 text-gray-500">
                    <svg class="w-12 h-12 mx-auto mb-4 text-blue-500 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356-2A8.001 8.001 0 004.582 19.58m15.356-2A8.001 8.001 0 014.582 4.42"></path></svg>
                    Memuat data master dan stok awal...
                    <p class="mt-2 text-xs">Pastikan Anda telah memasukkan kredensial Supabase yang benar.</p>
                </div>
            `;
        }
        
        // --- VIEW RENDERERS (Tetap Sama) ---

        function getProductById(id) {
            // Supabase menggunakan 'id' sebagai primary key secara default
            return window.appState.products.find(p => p.id === id);
        }

        function renderStockView(products, stockData) {
            const stockItems = products
                .map(product => ({ 
                    id: product.id, 
                    product: product, 
                    ...stockData[product.id] 
                }))
                .filter(item => item.product); 

            const totalStokGlobal = stockItems.reduce((sum, item) => sum + (item.stok_kecil || 0), 0);
            
            const tableRows = stockItems.map(item => {
                const stok = item.stok_kecil || 0;
                const stokClass = stok < 100 ? 'text-red-600 font-bold' : 'text-green-600';
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-3 text-sm font-medium text-gray-900">${item.product.nama_produk} <span class="text-xs text-gray-500 block">${item.product.sku}</span></td>
                        <td class="px-6 py-3 text-sm text-gray-500">${item.product.unit_besar} (${item.product.konversi_kecil} ${item.product.unit_kecil})</td>
                        <td class="px-6 py-3 text-sm ${stokClass}">
                            ${Number(stok).toLocaleString('id-ID')} ${item.product.unit_kecil}
                        </td>
                        <td class="px-6 py-3 text-sm text-gray-500">${Number(item.total_masuk_kecil || 0).toLocaleString('id-ID')}</td>
                        <td class="px-6 py-3 text-sm text-gray-500">${Number(item.total_keluar_kecil || 0).toLocaleString('id-ID')}</td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-md flex justify-between items-center border-l-4 border-blue-500">
                        <span class="text-gray-500 font-semibold">Total Stok Global (Unit Kecil)</span>
                        <span class="text-3xl font-bold text-blue-600">${totalStokGlobal.toLocaleString('id-ID')}</span>
                    </div>
                </div>

                <div class="bg-white p-4 sm:p-8 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">Detail Stok per Produk</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produk</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Konversi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stok Aktual (Unit Kecil)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Masuk (Kecil)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Keluar (Kecil)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows || '<tr><td colspan="5" class="py-4 text-center text-gray-500">Tidak ada data stok.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderMasterDataView(products, stockData) {
            let tableRows = products.map(p => {
                const stock = stockData[p.id] || { stok_kecil: 0 };
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-3 text-sm font-medium text-gray-900">${p.nama_produk}</td>
                        <td class="px-6 py-3 text-sm text-gray-500">${p.sku}</td>
                        <td class="px-6 py-3 text-sm text-gray-500">${p.unit_besar}</td>
                        <td class="px-6 py-3 text-sm text-gray-500">${p.unit_kecil}</td>
                        <td class="px-6 py-3 text-sm text-gray-500">${p.konversi_kecil} ${p.unit_kecil} / ${p.unit_besar}</td>
                        <td class="px-6 py-3 text-sm text-gray-500">
                            ${(stock.stok_kecil || 0).toLocaleString('id-ID')} ${p.unit_kecil}
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="flex justify-end mb-4">
                    <button id="open-master-modal-btn" class="btn-primary flex items-center space-x-2 px-4 py-2 rounded-lg font-semibold shadow-md transition duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        <span>Tambah Produk Baru</span>
                    </button>
                </div>
                
                <div class="bg-white p-4 sm:p-8 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">Daftar Produk Aktif (${products.length} Item)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Produk</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Besar</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Kecil</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Konversi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stok Saat Ini (Kecil)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows || '<tr><td colspan="6" class="py-4 text-center text-gray-500">Tidak ada data produk.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function renderOutgoingView(products, historyOutgoing) {
            const tableRows = historyOutgoing
                .sort((a, b) => new Date(b.created_at || b.tanggal_keluar) - new Date(a.created_at || a.tanggal_keluar))
                .map(tx => {
                const product = getProductById(tx.produk_id);
                // Supabase menggunakan 'created_at' secara default, tapi kita juga menerima tanggal_keluar
                const date = new Date(tx.created_at || tx.tanggal_keluar).toLocaleDateString('id-ID'); 
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-3 text-sm text-gray-500">${date}</td>
                        <td class="px-6 py-3 text-sm font-medium text-gray-900">${product ? product.nama_produk : 'N/A'}</td>
                        <td class="px-6 py-3 text-sm font-bold text-red-600">-${Number(tx.jumlah_unit_kecil).toLocaleString('id-ID')} ${product ? product.unit_kecil : ''}</td>
                        <td class="px-6 py-3 text-sm text-gray-500">${tx.tujuan || '-'}</td>
                        <td class="px-6 py-3 text-sm text-gray-500">${tx.catatan || '-'}</td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="flex justify-end mb-4">
                    <button id="open-outgoing-modal-btn" class="btn-danger flex items-center space-x-2 px-4 py-2 rounded-lg font-semibold shadow-md transition duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>Catat Barang Keluar</span>
                    </button>
                </div>
                
                <div class="bg-white p-4 sm:p-8 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">Riwayat Barang Keluar (${historyOutgoing.length} Transaksi)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produk</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah (Kecil)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tujuan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catatan</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="transactions-list">
                                ${tableRows || '<tr><td colspan="5" class="py-4 text-center text-gray-500">Belum ada data barang keluar.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderIncomingView(products, historyIncoming) {
            const tableRows = historyIncoming
                .sort((a, b) => new Date(b.created_at || b.tanggal_masuk) - new Date(a.created_at || a.tanggal_masuk))
                .map(tx => {
                const product = getProductById(tx.produk_id);
                const date = new Date(tx.created_at || tx.tanggal_masuk).toLocaleDateString('id-ID'); 
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-3 text-sm text-gray-500">${date}</td>
                        <td class="px-6 py-3 text-sm font-medium text-gray-900">${product ? product.nama_produk : 'N/A'}</td>
                        <td class="px-6 py-3 text-sm font-bold text-green-600">+${Number(tx.jumlah_unit_besar).toLocaleString('id-ID')} ${product ? product.unit_besar : ''}</td>
                        <td class="px-6 py-3 text-sm text-gray-500">${tx.sumber || '-'}</td>
                        <td class="px-6 py-3 text-sm text-gray-500">${tx.catatan || '-'}</td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="flex justify-end mb-4">
                    <button id="open-incoming-modal-btn" class="btn-success flex items-center space-x-2 px-4 py-2 rounded-lg font-semibold shadow-md transition duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        <span>Catat Barang Masuk</span>
                    </button>
                </div>
                
                <div class="bg-white p-4 sm:p-8 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">Riwayat Barang Masuk (${historyIncoming.length} Transaksi)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produk</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah (Besar)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sumber</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catatan</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="transactions-list">
                                ${tableRows || '<tr><td colspan="5" class="py-4 text-center text-gray-500">Belum ada data barang masuk.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // --- DYNAMIC LISTENERS (RUN AFTER RENDER) ---
        function attachDynamicListeners() {
            // ... (Fungsi attachDynamicListeners tetap sama)
            const modal = document.getElementById('transaction-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContentArea = document.getElementById('modal-content-area');
            
            document.getElementById('close-modal-btn').onclick = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };

            // 1. Master Data Modal (Add Product)
            const openMasterModalBtn = document.getElementById('open-master-modal-btn');
            if (openMasterModalBtn) {
                openMasterModalBtn.onclick = () => {
                    modalTitle.textContent = 'Tambah Produk Baru';
                    modalContentArea.innerHTML = getMasterDataForm();
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    document.getElementById('add-product-form').onsubmit = handleAddProduct;
                };
            }
            
            // 2. Incoming Modal (Add Incoming)
            const openIncomingModalBtn = document.getElementById('open-incoming-modal-btn');
            if (openIncomingModalBtn) {
                openIncomingModalBtn.onclick = () => {
                    window.appState.draftTransactions = []; // Reset draft for new modal open
                    modalTitle.textContent = 'Catat Barang Masuk (Batch)';
                    modalContentArea.innerHTML = getTransactionForm('incoming');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    setupTransactionFormListeners('incoming');
                    updateDraftUI('incoming');
                };
            }

            // 3. Outgoing Modal (Add Outgoing)
            const openOutgoingModalBtn = document.getElementById('open-outgoing-modal-btn');
            if (openOutgoingModalBtn) {
                openOutgoingModalBtn.onclick = () => {
                    window.appState.draftTransactions = []; // Reset draft for new modal open
                    modalTitle.textContent = 'Catat Barang Keluar (Batch)';
                    modalContentArea.innerHTML = getTransactionForm('outgoing');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    setupTransactionFormListeners('outgoing');
                    updateDraftUI('outgoing');
                };
            }
        }
        
        // --- FORM GENERATORS (Tetap Sama) ---

        function getMasterDataForm() {
            return `
                <form id="add-product-form" class="space-y-4 p-4 bg-gray-50 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="nama_produk" class="block text-sm font-medium text-gray-700">Nama Produk</label>
                            <input type="text" id="nama_produk" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                        </div>
                        <div>
                            <label for="sku" class="block text-sm font-medium text-gray-700">SKU/Kode Barang</label>
                            <input type="text" id="sku" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="unit_besar" class="block text-sm font-medium text-gray-700">Unit Besar (Contoh: Dus)</label>
                            <input type="text" id="unit_besar" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                        </div>
                        <div>
                            <label for="unit_kecil" class="block text-sm font-medium text-gray-700">Unit Kecil (Contoh: Botol)</label>
                            <input type="text" id="unit_kecil" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                        </div>
                        <div>
                            <label for="konversi_kecil" class="block text-sm font-medium text-gray-700">Konversi (Jml Unit Kecil per Unit Besar)</label>
                            <input type="number" id="konversi_kecil" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="1" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full btn-primary px-4 py-2 rounded-lg font-semibold transition duration-200">Simpan Produk</button>
                </form>
            `;
        }

        function getTransactionForm(type) {
            const { products, stockData } = window.appState;
            const isOutgoing = type === 'outgoing';
            const quantityLabel = isOutgoing ? 'Jumlah Keluar (Unit Kecil)' : 'Jumlah Masuk (Unit Besar)';
            const primaryLabel = isOutgoing ? 'Tujuan/Pelanggan' : 'Sumber/Supplier';
            const primaryId = isOutgoing ? 'tujuan' : 'sumber';
            const primaryPlaceholder = isOutgoing ? 'Cth: Penjualan Toko A' : 'Cth: Supplier PT. ABC';

            let productOptions = products.map(p => {
                const stockItem = stockData[p.id] || { stok_kecil: 0 };
                const disabled = isOutgoing && (stockItem.stok_kecil || 0) <= 0 ? 'disabled' : '';
                const stockText = isOutgoing ? `(Stok: ${(stockItem.stok_kecil || 0).toLocaleString('id-ID')} ${p.unit_kecil})` : '';
                return `
                    <option value="${p.id}" data-unit-text="${isOutgoing ? p.unit_kecil : p.unit_besar}" data-konversi="${p.konversi_kecil}" ${disabled}>
                        ${p.nama_produk} ${stockText}
                    </option>`;
            }).join('');

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Kolom Kiri: Formulir Input Item -->
                    <div class="lg:col-span-1 border-r lg:pr-6">
                        <h4 class="text-lg font-semibold mb-3 text-gray-700">Tambah Item ke Draft</h4>
                        <form id="add-item-form" class="space-y-4">
                            <div>
                                <label for="product-select" class="block text-sm font-medium text-gray-700">Produk</label>
                                <select id="product-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                                    <option value="">Pilih Produk</option>
                                    ${productOptions}
                                </select>
                            </div>
                            <div>
                                <label for="jumlah" class="block text-sm font-medium text-gray-700">${quantityLabel}</label>
                                <input type="number" id="jumlah" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="1" required>
                                <p id="unit-display" class="mt-1 text-xs text-gray-500"></p>
                                <p id="stok-warning" class="mt-1 text-xs text-red-500 hidden font-semibold"></p>
                            </div>
                            <div>
                                <label for="${primaryId}" class="block text-sm font-medium text-gray-700">${primaryLabel}</label>
                                <input type="text" id="${primaryId}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="${primaryPlaceholder}" required>
                            </div>
                            <div>
                                <label for="catatan" class="block text-sm font-medium text-gray-700">Catatan (Opsional)</label>
                                <input type="text" id="catatan" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <button type="submit" class="w-full ${isOutgoing ? 'btn-danger' : 'btn-success'} px-4 py-2 rounded-lg font-semibold transition duration-200" id="add-item-btn">Tambahkan ke Draft</button>
                        </form>
                    </div>

                    <!-- Kolom Kanan: Daftar Draft dan Tombol Simpan -->
                    <div class="lg:col-span-2">
                        <h4 class="text-lg font-semibold mb-3 text-gray-700">Draft Transaksi (<span id="draft-count">0</span> Item)</h4>
                        
                        <div id="draft-list-container" class="space-y-3 max-h-80 overflow-y-auto p-2 border rounded-md bg-gray-50 mb-4">
                            <p id="empty-draft-message" class="text-center text-gray-500 py-4">Draft kosong. Tambahkan item di samping.</p>
                        </div>

                        <div class="flex justify-between items-center pt-4 border-t">
                            <button id="clear-draft-btn" class="text-red-500 hover:text-red-700 text-sm disabled:opacity-50" disabled>Hapus Draft</button>
                            <button id="save-batch-btn" class="px-6 py-3 rounded-lg font-bold disabled:opacity-50 ${isOutgoing ? 'btn-danger' : 'btn-success'}">
                                Simpan & Approve (<span id="save-count">0</span>)
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- HANDLERS & LOGIC ---
        
        // Master Data Handler (Supabase)
        async function handleAddProduct(e) {
            e.preventDefault();
            const nama_produk = document.getElementById('nama_produk').value.trim();
            const sku = document.getElementById('sku').value.trim();
            const unit_besar = document.getElementById('unit_besar').value.trim();
            const unit_kecil = document.getElementById('unit_kecil').value.trim();
            const konversi_kecil = parseInt(document.getElementById('konversi_kecil').value);

            if (!nama_produk || !sku || !unit_besar || !unit_kecil || konversi_kecil < 1) {
                showToast("Semua field harus diisi dengan benar.", 'error');
                return;
            }
            
            // Supabase: Cek duplikasi SKU
            const { data: existing, error: fetchError } = await supabase
                .from('products')
                .select('sku')
                .eq('sku', sku);
                
            if (fetchError) {
                 console.error("Error checking SKU:", fetchError);
                 showToast("Gagal memeriksa SKU.", 'error');
                 return;
            }

            if (existing && existing.length > 0) {
                 showToast("SKU ini sudah digunakan. Mohon gunakan SKU yang berbeda.", 'error');
                 return;
            }

            try {
                const { error } = await supabase
                    .from('products')
                    .insert([{ nama_produk, sku, unit_besar, unit_kecil, konversi_kecil }]);
                
                if (error) throw error;
                
                showToast(`Produk '${nama_produk}' berhasil ditambahkan! Memuat ulang data...`, 'success');
                document.getElementById('transaction-modal').classList.add('hidden');
                document.getElementById('transaction-modal').classList.remove('flex');
                
                // Muat ulang data secara keseluruhan untuk refresh UI
                await loadAllData(); 
            } catch (error) {
                console.error("Error adding product:", error);
                showToast("Gagal menyimpan produk. Cek koneksi Supabase Anda.", 'error');
            }
        }
        
        // Transaction Draft Logic (Tetap Sama)
        function setupTransactionFormListeners(type) {
            // ... (Logika listeners formulir transaksi tetap sama)
            const isOutgoing = type === 'outgoing';
            const primaryId = isOutgoing ? 'tujuan' : 'sumber';

            const productSelect = document.getElementById('product-select');
            const jumlahInput = document.getElementById('jumlah');
            const addItemForm = document.getElementById('add-item-form');
            
            // Function to update unit text and check stock/quantity on change/input
            const updateFormState = () => {
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                const produkId = selectedOption ? selectedOption.value : null;
                const unitDisplay = document.getElementById('unit-display');
                const stokWarning = document.getElementById('stok-warning');
                const addItemBtn = document.getElementById('add-item-btn');
                
                unitDisplay.textContent = '';
                stokWarning.classList.add('hidden');
                addItemBtn.disabled = false;
                
                if (produkId) {
                    const product = getProductById(produkId);
                    const stockItem = window.appState.stockData[produkId] || { stok_kecil: 0 };
                    
                    const unitText = selectedOption.getAttribute('data-unit-text');
                    unitDisplay.textContent = `Unit: ${unitText}`;
                    
                    if (isOutgoing) {
                        const currentStok = stockItem.stok_kecil || 0;
                        unitDisplay.textContent = `Unit: ${unitText}. Stok tersedia: ${currentStok.toLocaleString('id-ID')} ${unitText}`;
                        
                        const jumlah = parseInt(jumlahInput.value) || 0;
                        if (jumlah <= 0) {
                            stokWarning.textContent = `Jumlah harus lebih dari 0.`;
                            stokWarning.classList.remove('hidden');
                            addItemBtn.disabled = true;
                        } else if (jumlah > currentStok) {
                            stokWarning.textContent = `Stok tidak cukup! Maksimum: ${currentStok.toLocaleString('id-ID')} ${unitText}`;
                            stokWarning.classList.remove('hidden');
                            addItemBtn.disabled = true;
                        }
                    }
                } else {
                    addItemBtn.disabled = true;
                }
            };
            
            productSelect.onchange = updateFormState;
            jumlahInput.oninput = updateFormState;
            productSelect.dispatchEvent(new Event('change'));

            // Handle Add Item to Draft
            addItemForm.onsubmit = (e) => {
                e.preventDefault();
                const produkId = productSelect.value;
                const jumlah = parseInt(jumlahInput.value);
                const primaryValue = document.getElementById(primaryId).value.trim();
                const catatan = document.getElementById('catatan').value.trim();
                const product = getProductById(produkId);

                if (!produkId || jumlah <= 0 || !primaryValue || !product) {
                    showToast("Data input tidak lengkap atau tidak valid.", 'error');
                    return;
                }

                if (isOutgoing) {
                    const stockItem = window.appState.stockData[produkId] || { stok_kecil: 0 };
                    const currentStok = stockItem.stok_kecil || 0;
                    
                    if (jumlah > currentStok) {
                        showToast(`Gagal: Stok ${product.nama_produk} tidak cukup.`, 'error');
                        return;
                    }
                    // Outgoing item is stored as unit kecil
                    window.appState.draftTransactions.push({
                        produk_id: produkId,
                        jumlah_unit_kecil: jumlah,
                        tujuan: primaryValue,
                        catatan: catatan,
                        // Supabase akan otomatis menambahkan created_at, tapi kita tambahkan tanggal untuk konsistensi di UI jika created_at hilang
                        tanggal_keluar: new Date().toISOString().split('T')[0],
                    });
                } else {
                    // Incoming item is stored as unit besar
                    window.appState.draftTransactions.push({
                        produk_id: produkId,
                        jumlah_unit_besar: jumlah,
                        sumber: primaryValue,
                        catatan: catatan,
                         // Supabase akan otomatis menambahkan created_at, tapi kita tambahkan tanggal untuk konsistensi di UI jika created_at hilang
                        tanggal_masuk: new Date().toISOString().split('T')[0],
                    });
                }

                document.getElementById('add-item-form').reset();
                productSelect.dispatchEvent(new Event('change')); 
                updateDraftUI(type);
                showToast(`Item ${product.nama_produk} ditambahkan ke draft.`, 'success');
            };
            
            // Handle Clear Draft
            document.getElementById('clear-draft-btn').onclick = () => {
                showCustomConfirmation("Yakin ingin menghapus semua draft transaksi ini?", () => {
                    window.appState.draftTransactions = [];
                    updateDraftUI(type);
                    showToast("Draft transaksi telah dikosongkan.", 'info');
                });
            };

            // Handle Save Batch
            document.getElementById('save-batch-btn').onclick = () => handleSaveBatch(type);
        }
        
        function updateDraftUI(type) {
             // ... (Logika update Draft UI tetap sama)
            const { products, draftTransactions, stockData } = window.appState;
            const isOutgoing = type === 'outgoing';
            const draftListContainer = document.getElementById('draft-list-container');
            const draftCount = document.getElementById('draft-count');
            const saveCount = document.getElementById('save-count');
            const emptyMessage = document.getElementById('empty-draft-message');
            const saveBtn = document.getElementById('save-batch-btn');
            const clearBtn = document.getElementById('clear-draft-btn');
            
            draftListContainer.innerHTML = '';
            
            if (draftTransactions.length === 0) {
                emptyMessage.classList.remove('hidden');
                draftListContainer.appendChild(emptyMessage);
                saveBtn.disabled = true;
                clearBtn.disabled = true;
            } else {
                emptyMessage.classList.add('hidden');
                
                let hasOverstockedItem = false;
                
                draftTransactions.forEach((item, index) => {
                    const product = getProductById(item.produk_id);
                    const stockItem = window.appState.stockData[item.produk_id] || { stok_kecil: 0 };
                    const currentStok = stockItem.stok_kecil || 0;
                    
                    let primaryText = isOutgoing ? item.tujuan : item.sumber;
                    let quantityText;
                    let isError = false;

                    if (isOutgoing) {
                        quantityText = `${item.jumlah_unit_kecil.toLocaleString('id-ID')} ${product ? product.unit_kecil : ''}`;
                        // Cek stok secara real-time vs stok saat ini
                        if (item.jumlah_unit_kecil > currentStok) {
                            isError = true;
                            hasOverstockedItem = true;
                        }
                    } else {
                        quantityText = `${item.jumlah_unit_besar.toLocaleString('id-ID')} ${product ? product.unit_besar : ''}`;
                    }

                    const itemDiv = document.createElement('div');
                    itemDiv.className = `flex justify-between items-center p-3 bg-white rounded-lg shadow-sm ${isError ? 'border-2 border-red-400' : ''}`;
                    itemDiv.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold truncate">${product ? product.nama_produk : 'N/A'}</p>
                            <p class="text-xs text-gray-600">Jml: ${quantityText} | ${isOutgoing ? 'Tujuan' : 'Sumber'}: ${primaryText}</p>
                            ${isError ? '<p class="text-xs text-red-500 font-bold">STOK KURANG (Hapus Item ini)</p>' : ''}
                        </div>
                        <button type="button" data-index="${index}" class="remove-draft-btn text-red-500 hover:text-red-700 ml-4 p-1 rounded-full hover:bg-red-100">
                            &times;
                        </button>
                    `;
                    draftListContainer.appendChild(itemDiv);
                });
                
                draftListContainer.querySelectorAll('.remove-draft-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.getAttribute('data-index'));
                        window.appState.draftTransactions.splice(index, 1);
                        updateDraftUI(type);
                    });
                });
                
                // Menonaktifkan tombol simpan jika ada item yang kekurangan stok
                saveBtn.disabled = hasOverstockedItem || draftTransactions.length === 0;
                clearBtn.disabled = false;
            }
            
            draftCount.textContent = draftTransactions.length;
            saveCount.textContent = draftTransactions.length;
        }

        // Save Batch Handler (Supabase)
        async function handleSaveBatch(type) {
            const { draftTransactions } = window.appState;
            if (draftTransactions.length === 0) return;

            const isOutgoing = type === 'outgoing';
            const tableName = isOutgoing ? 'outgoing' : 'incoming';

            // Lakukan pengecekan stok terakhir untuk Barang Keluar sebelum commit
            if (isOutgoing) {
                let tempStockData = { ...window.appState.stockData }; 
                for (const item of draftTransactions) {
                    const stock = tempStockData[item.produk_id] ? tempStockData[item.produk_id].stok_kecil : 0;
                    if (item.jumlah_unit_kecil > stock) {
                        showToast("Simpan batch dibatalkan karena ada item yang kekurangan stok saat konfirmasi.", 'error');
                        return;
                    }
                    // Simulasi pengurangan stok untuk item batch berikutnya
                    tempStockData[item.produk_id].stok_kecil -= item.jumlah_unit_kecil; 
                }
            }
            
            try {
                const { error } = await supabase
                    .from(tableName)
                    .insert(draftTransactions);

                if (error) throw error;

                // Success
                const numItems = draftTransactions.length;
                window.appState.draftTransactions = [];
                updateDraftUI(type);
                
                document.getElementById('transaction-modal').classList.add('hidden');
                document.getElementById('transaction-modal').classList.remove('flex');

                showToast(`${numItems} transaksi ${isOutgoing ? 'Barang Keluar' : 'Barang Masuk'} berhasil disimpan. Memuat ulang data...`, 'success');
                
                // Muat ulang data secara keseluruhan untuk refresh UI dan perhitungan stok
                await loadAllData(); 
                
            } catch (error) {
                console.error("Error committing batch:", error);
                showToast(`Gagal menyimpan transaksi batch: ${error.message}`, 'error');
            }
        }


        // --- UTILITY: CUSTOM CONFIRMATION MODAL (Ganti window.confirm) ---
        function showCustomConfirmation(message, onConfirm) {
            // ... (Fungsi modal kustom tetap sama)
            const modal = document.getElementById('transaction-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContentArea = document.getElementById('modal-content-area');

            modalTitle.textContent = "Konfirmasi";
            modalContentArea.innerHTML = `
                <p class="text-lg text-gray-700 mb-6">${message}</p>
                <div class="flex justify-end space-x-4">
                    <button id="cancel-confirm-btn" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold">Batal</button>
                    <button id="execute-confirm-btn" class="px-4 py-2 rounded-lg btn-danger font-semibold">Ya, Hapus</button>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            document.getElementById('cancel-confirm-btn').onclick = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };

            document.getElementById('execute-confirm-btn').onclick = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                onConfirm();
            };
        }

        // --- UTILITY: TOAST NOTIFICATION ---
        function showToast(message, type = 'info') {
             // ... (Fungsi toast notifikasi tetap sama)
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let bgColor = 'bg-blue-500';
            if (type === 'success') bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'info') bgColor = 'bg-gray-500';

            toast.className = `p-3 rounded-lg text-white shadow-xl ${bgColor} flex items-center space-x-2 transition duration-300 transform opacity-0 translate-y-2`;
            toast.textContent = message;

            container.appendChild(toast);
            
            // Animasi masuk
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-y-2');
                toast.classList.add('opacity-100', 'translate-y-0');
            }, 50); 

            // Animasi keluar
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // --- START APPLICATION ---
        loadAllData();

        // Setup Navigation Listener
        window.addEventListener('hashchange', handleNavigation);
        handleNavigation(); // Initial page load

        // Mobile Sidebar Toggle
        document.getElementById('menu-toggle').addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        });
    </script>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden">

    <!-- Ikon Menu Toggle (Hanya terlihat di mobile) -->
    <button id="menu-toggle" class="lg:hidden fixed top-4 left-4 p-2 rounded-lg bg-white shadow-lg z-50">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
    </button>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar bg-sidebar flex flex-col fixed h-full shadow-lg lg:relative lg:translate-x-0">
        <div class="p-6 text-white border-b border-gray-700/50">
            <h1 class="text-2xl font-bold tracking-wider">InventPro (SB)</h1>
            <p class="text-xs text-gray-400">Sistem Manajemen Inventori</p>
        </div>
        <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
            <p class="text-xs font-semibold uppercase text-gray-500/70 px-4 pt-4 pb-2">Dashboard & Stok</p>
            
            <a href="#stock" data-page="stock" class="nav-link flex items-center space-x-3 p-3 rounded-lg text-sidebar-inactive hover:bg-sidebar-active hover:text-sidebar-active font-medium transition duration-150">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-6v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                <span>Stok Saat Ini</span>
            </a>

            <p class="text-xs font-semibold uppercase text-gray-500/70 px-4 pt-4 pb-2">Transaksi</p>
            
            <a href="#incoming" data-page="incoming" class="nav-link flex items-center space-x-3 p-3 rounded-lg text-sidebar-inactive hover:bg-sidebar-active hover:text-sidebar-active font-medium transition duration-150">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>Barang Masuk</span>
            </a>
            
            <a href="#outgoing" data-page="outgoing" class="nav-link flex items-center space-x-3 p-3 rounded-lg text-sidebar-inactive hover:bg-sidebar-active hover:text-sidebar-active font-medium transition duration-150">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>Barang Keluar</span>
            </a>
            
            <p class="text-xs font-semibold uppercase text-gray-500/70 px-4 pt-4 pb-2">Master Data</p>

            <a href="#master" data-page="master" class="nav-link flex items-center space-x-3 p-3 rounded-lg text-sidebar-inactive hover:bg-sidebar-active hover:text-sidebar-active font-medium transition duration-150">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10m0 0h16m0 0V7m-9 4h3m-3 4h3m-4 0h1m-1 0v4m0-4h4"></path></svg>
                <span>Data Produk</span>
            </a>

        </nav>
        <div class="p-4 text-xs text-gray-500/70 border-t border-gray-700/50">
            <span id="user-id-display" class="block truncate">User ID: demo-user</span>
             2024 InventPro v2.2 (Supabase)
        </div>
    </div>

    <!-- Area Konten Utama -->
    <div class="main-content flex-1 flex flex-col overflow-hidden">
        
        <!-- Header Utama / Navbar Atas -->
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shadow-sm">
            <h2 id="page-title" class="text-xl font-semibold text-gray-800">Memuat...</h2>
        </header>

        <!-- Konten Halaman Utama (Dynamic Content Container) -->
        <main id="app-content" class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-6">
            ${renderLoadingState()}
        </main>
    </div>

    <!-- Modal for Outgoing/Incoming (Reused for simplicity) -->
    <div id="transaction-modal" class="modal-backdrop fixed inset-0 hidden items-center justify-center p-4">
        <div class="modal-content bg-white w-full max-w-4xl rounded-xl shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-800">Catat Transaksi</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            
            <div id="modal-content-area">
                <!-- Content will be injected here by JS -->
            </div>
            
        </div>
    </div>
    
    <!-- Toast/Notification Area -->
    <div id="toast-container" class="fixed bottom-4 right-4 space-y-2"></div>
    
</body>
</html>
